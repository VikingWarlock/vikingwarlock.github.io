<!DOCTYPE html>
<html>

<head>
  
  <title>Android上的蓝牙 | VikingWarlock</title>
  <meta name="google-site-verification" content="" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta itemprop="name" content="VikingWarlock" />
  <meta itemprop="description" content="VKWK's blog" />
  <meta itemprop="image" content="" />
  <link rel="shortcut icon" href="" type="image/x-icon">
  <!-- keywords and description -->
  
  <meta name="keywords" content="" />
  <meta name="description" content="Bluetooth makes the world tighter" />
  
  
<link rel="stylesheet" href="/hexosource/css/style.css">

  <script src="//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js" integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
      onload="renderMathInElement(document.body);"></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <div id="container">
    <header>
  <div class="site-title">
    <a href="/">
      VikingWarlock
    </a>
  </div>
  
  <div class="site-subtitle">
    VKWK's blog
  </div>
  
  
  <p class="links">
    
    <a href="">
      <img src="/images/links/" alt="">
    </a>
    
  </p>
  
</header>
    <div id="main">
      <article class="post">
  <h3 class="date">
  <time datetime="2016-12-14T02:40:57.000Z">
    Dec 14, 2016
  </time>
</h3>
  <h1>Android上的蓝牙</h1>
  <p class="post-info">
  
  <span class="post-info-item author">VikingWarlock</span>
  
  
  <a href="/hexosource/programming/20161214-filter-bluetooth-in-android.html#waline" class="post-info-item comment-count waline-comment-count" id="/hexosource/programming/20161214-filter-bluetooth-in-android.html">获取中...</a>
  <span class="post-info-item view-count waline-visitor-count" id="/hexosource/programming/20161214-filter-bluetooth-in-android.html">获取中...</span>
  
</p>
  
<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/hexosource/tags/ble/" rel="tag">蓝牙</a></li></ul>

  
  <article>
    <h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>如果说Android和iOS一样,一出新版本,每个用户都回去升级,那我就不用写这篇咯</p>
<h4 id="先说说iOS端的蓝牙扫描"><a href="#先说说iOS端的蓝牙扫描" class="headerlink" title="先说说iOS端的蓝牙扫描"></a>先说说iOS端的蓝牙扫描</h4><pre><code>@param serviceUUIDs A list of &lt;code&gt;CBUUID&lt;/code&gt; objects representing the service(s) to scan for.
//serviceUUIDs是一个过滤NSArray
//根据蓝牙外设的广播信号中的Service UUID来过滤
- (void)scanForPeripheralsWithServices:(nullable NSArray&lt;CBUUID *&gt; *)serviceUUIDs options:(nullable NSDictionary&lt;NSString *, id&gt; *)options;
</code></pre><p>假定说,我们的app需要过滤两个产品的蓝牙信号.那么只要在serviceUUIDs里面填写他们<code>特有</code>Service UUID.</p>
<p>然后,在代理方法中做区分.</p>
<pre><code>- (void)centralManager:(CBCentralManager *)central didDiscoverPeripheral:(CBPeripheral *)peripheral advertisementData:(NSDictionary&lt;NSString *, id&gt; *)advertisementData RSSI:(NSNumber *)RSSI{
    // 从广播信号中获取Service UUID 的列表
    NSArray *serviceUUIDs=advertisementData[CBAdvertisementDataServiceUUIDsKey];
    //做一下判断
    if ([serviceUUIDs containsObject:[CBUUID UUIDWithString:@&quot;FFFF&quot;]]){
        //欧耶,这是我们的产品1
    }else if ([serviceUUIDs containsObject:[CBUUID UUIDWithString:@&quot;FFFF&quot;]]){
        //欧耶,这是产品2
        //直接else当然也可以.但是要保险一些嘛
    }
}
</code></pre><p>方便,真是方便</p>
<h2 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h2><p>Android中,貌似没有那么轻松</p>
<p>当然,这就要提起<code>Context</code>里面说的事情了.</p>
<p>BLE是android 4.3引入的,所以最早拥有蓝牙更能的版本,就是API 18.</p>
<p>大概是由于API 18中,蓝牙搜索的方法,有点儿蛋疼,所以,他们改了新的方法吧?</p>
<h3 id="API-21"><a href="#API-21" class="headerlink" title="API 21"></a>API 21</h3><p>先看看API 21怎么搜索蓝牙的.</p>
<p>BluetoothAdapter的一个静态方法</p>
<pre><code>void startScan (List&lt;ScanFilter&gt; filters,ScanSettings settings,ScanCallback callback)
</code></pre><table>
<thead>
<tr>
<th>参数</th>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>filters</td>
<td>List</td>
<td>ScanFilters for finding exact BLE devices.</td>
</tr>
<tr>
<td>settings</td>
<td>ScanSettings</td>
<td>Settings for the scan.</td>
</tr>
<tr>
<td>callback</td>
<td>ScanCallback</td>
<td>Callback used to deliver scan results.</td>
</tr>
</tbody>
</table>
<p>其中ScanFilter很牛逼</p>
<pre><code>Service UUIDs which identify the bluetooth gatt services running on the device.
Name of remote Bluetooth LE device.
Mac address of the remote device.
Service data which is the data associated with a service.
Manufacturer specific data which is the data associated with a particular manufacturer.
</code></pre><p>这过滤方法,可比iOS的搜索强多了</p>
<p>然而,这个是API 21才有的……</p>
<h3 id="API-18"><a href="#API-18" class="headerlink" title="API 18"></a>API 18</h3><p>由于,咱们要覆盖所有的,拥有BLE功能的手机用户</p>
<p>所以,只能用API 18了.</p>
<pre><code>boolean startLeScan (UUID[] serviceUuids, BluetoothAdapter.LeScanCallback callback);
</code></pre><p>这过滤,和iOS一样了,只能用serviceUUID来过滤.</p>
<p>不过,通过我的实际测试,我发现<code>serviceUuids</code>填写的不能是不同设备的service uuid.</p>
<p>这样做,总是会显示没有<code>match uuid list</code> (有机会再好好研究一下)</p>
<p>那过滤两种设备,可以选择,做两遍这个方法,给不同的callback,好像还省去了用<code>if</code>去判断设备这个工作.</p>
<h4 id="但是-如果有一大排设备需要去过滤呢……"><a href="#但是-如果有一大排设备需要去过滤呢……" class="headerlink" title="但是,如果有一大排设备需要去过滤呢……"></a>但是,如果有一大排设备需要去过滤呢……</h4><pre><code>boolean startLeScan (BluetoothAdapter.LeScanCallback callback);
</code></pre><p>直接全部搜索吧……还过滤啥呀</p>
<p>手动解析广播数据,进行分类,做不同的操作</p>
<pre><code>BluetoothAdapter.LeScanCallback bluetoothScanCallback = new BluetoothAdapter.LeScanCallback() {

    @Override
    public void onLeScan(BluetoothDevice bluetoothDevice, int i, byte[] bytes) {
        //已经搜索过的设备,就不用重新解析啦
        if (locatorList.containsKey(bluetoothDevice.getAddress())){
            LocatorPeripheral peripheral=locatorList.get(bluetoothDevice.getAddress());
            peripheral.updateInformation(i);
        }else if(keyList.containsKey(bluetoothDevice.getAddress())){
            KeyPeripheral peripheral=keyList.get(bluetoothDevice.getAddress());
            peripheral.updateInformation(i);
        }else if(ignoreList.contains(bluetoothDevice)){
            return;
        } else {
            //这里开始重新解析
            VKPeripheral peripheral = VKPeripheral.createPeripheral(i,bytes,bluetoothDevice);
            if (peripheral instanceof LocatorPeripheral){
                //这是设备1
                locatorList.put(bluetoothDevice.getAddress(),(LocatorPeripheral) peripheral);
            }else if (peripheral instanceof KeyPeripheral){
                //这是设备2
                keyList.put(bluetoothDevice.getAddress(),(KeyPeripheral) peripheral);
            }else {
                //这不是咱们的东西
                ignoreList.add(bluetoothDevice);
                return;
            }
            //通知UI

        }
    }
};
</code></pre><p>我水平有限,所以就是这样写的~</p>
<p>这里有个VKPeripheral <code>类名也是直接从iOS版移植过来了</code></p>
<p>用来根据广播信息来新建我自己的蓝牙设备实例.</p>
<p>他生成的KeyPeripheral和LocatorPeripheral都是他的子类.如果不是我们需要的设备,就加到忽略的列表中去.</p>
<h3 id="还有几个小坑"><a href="#还有几个小坑" class="headerlink" title="还有几个小坑"></a>还有几个小坑</h3><p>1.从android 6.0开始,蓝牙扫描如果需要得到结果,就必须获得定位权限(你逗我的吧…凭什么呀)</p>
<p>所以要把这个加到Manifest里面去</p>
<pre><code>&lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;/&gt;
</code></pre><p>2.还是android 6.0的锅. 由于6.0可以动态获取权限,所以上面这个权限,直接写在Manifest里面,说不定还没用呢…<br>还要手动的去获取权限</p>
<p>找个Activity加上这一段(不唯一)</p>
<pre><code>if (ContextCompat.checkSelfPermission(MainActivity.this, Manifest.permission.ACCESS_FINE_LOCATION)!= PackageManager.PERMISSION_GRANTED) {
    ActivityCompat.requestPermissions(MainActivity.this, new String[]{Manifest.permission.ACCESS_FINE_LOCATION,Manifest.permission.ACCESS_COARSE_LOCATION},1);
}else if(ContextCompat.checkSelfPermission(MainActivity.this,Manifest.permission.BLUETOOTH)!=PackageManager.PERMISSION_GRANTED){
    ActivityCompat.requestPermissions(MainActivity.this, new String[]{Manifest.permission.BLUETOOTH,Manifest.permission.BLUETOOTH_ADMIN},1);
}else {
    //你是不是不想用这个App!!
}
</code></pre><h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>哎,灵活的Android呀.开放的Android呀.</p>

  </article>
  
  <hr>
  <blockquote>
    <p>
      本文由 <a href="">VikingWarlock</a> 创作，采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0</a> 国际许可协议。
    </p>
    <p>
      本站文章除注明转载/出处外，均为本站原创或翻译，转载请务必署名。
    </p>
  </blockquote>
  
</article>


<div id="waline"></div>

    </div>
  </div>
  <footer>
  
  
  <p id="busuanzi_container_site_pv">
    本站访问量 <span id="busuanzi_value_site_pv">获取中...</span>
  </p>
  
  <p>
    Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/syy11cn/hexo-theme-linear">Linear</a> from <a target="_blank" rel="noopener" href="https://syy11.cn">Yiyang Sun</a>
  </p>
</footer>
  
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  <script>
    Waline({
      el: '#waline',
      placeholder: '',
      avatar: 'retro',
      visitor: true,
      requiredFields: ['nick', 'mail'],
      serverURL: '',
      emoji: [
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/alus',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo',
        'https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba',
      ]
    });
  </script>
</body>

</html>