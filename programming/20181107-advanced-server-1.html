<!DOCTYPE HTML>
<html>
<head >
  <meta charset="utf-8">
  
  <title>厉害一些的服务器设计(1) | VikingWarlock | VKWK&#39;s blog</title>

  
  <meta name="author" content="Viking Warlock">
  

  
  <meta name="description" content="VikingWarlock&#39;s daily life and develop experience">
  

  
  
  <meta name="keywords" content="Python">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="厉害一些的服务器设计(1)"/>

  <meta property="og:site_name" content="VikingWarlock"/>

  
  <meta property="og:image" content="/hexosource/favicon.ico"/>
  
  
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5005349780815724",
    enable_page_level_ads: true
  });
</script>

  
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?223eea22355699157e147870eb124b24";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


  <link rel="manifest" href="/manifest.json">
  <link href="/hexosource/favicon.ico" rel="icon">

  <link rel="alternate" href="/hexosource/atom.xml" title="VikingWarlock" type="application/atom+xml">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/hexosource/css/base/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/hexosource/css/style.css" media="screen" type="text/css">


<meta name="generator" content="Hexo 5.3.0"></head>


<body>
<div class="blog">
  <div class="content">

    

    <header class="header-container" style="background-image: url('/images/blog-bg.jpg');">


<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header page-scroll">
          <button type="button" id="tglBtn" class="navbar-toggle">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Viking Warlock</a>
        </div>
        <div id="bosenyblog-navbar">
          <div class="navbar-collapse" id="bs-example-navbar-collapse-6">
            <ul class="nav navbar-nav navbar-right">
            
              <li><a href="/hexosource/">主页</a></li>
            
              <li><a href="/hexosource/archives">归档</a></li>
            
              <li><a href="/hexosource/about">关于</a></li>
            
              <li><a href="/hexosource/tags">标签</a></li>
            
            </ul>
          </div>
        </div>

    </div>
 </nav>
 <div class="gotop-btn">

 </div>
</header>

        
          <div class="container ">
          <div class="row">
            <main class="site-main posts-loop col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container" style="position: inherit;">
            <article class="article-container ">

  
    
    <h3 class="article-title"><span>厉害一些的服务器设计(1)</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/hexosource/programming/20181107-advanced-server-1.html" rel="bookmark">
        <time class="entry-date published" datetime="2018-11-06T23:50:21.000Z">
          2018-11-07
        </time>
      </a>
    </span>
    <br />
    
    <span id="busuanzi_container_page_pv">
      本文总阅读量<span id="busuanzi_value_page_pv"></span>次
    </span>
    
  </div>


  

  <div class="article-content">
    <div class="entry">
      
          <h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>这段时间看了一些架构师的书，感觉是时候练习一下了。</p>
<p>一开始订了一个小目标，做一个http+socket的服务器</p>
<p>后来想了想，把celery加进来</p>
<p>再想把redis也加进来</p>
<p>最后这个就变成了一个更厉害一点儿的系统了</p>
<p>http<->nginx<->uwsgi<->django-&gt;rabbitMQ,redis,celery<->twisted<->socket</-></-></-></-></-></p>
<p>由于最近还看了微服务的书，所以最后甚至想做一个分布式的服务器了！</p>
<h4 id="Plan"><a href="#Plan" class="headerlink" title="Plan"></a>Plan</h4><p>这里不讲方案的演变过程，直接讲最后最后确定的方案。</p>
<p>一台高性能服务器装有 nginx,uwsgi,django,rabbitMQ,redis,twisted,celery</p>
<p>两台低配服务器有 twisted和celery</p>
<p>把这整个项目想像成，共享单车(非蓝牙开锁的)服务器架构～高性能服务器用来接受所有的http请求(手机app)，所有服务器的twisted用来处理socket请求(共享单车)</p>
<p>其中celery用来做部分异步操作（假设有发短信，发送单车指令）的负载均衡</p>
<p>rabbitMQ用来做celery和twisted的Message Broker。celery的相关操作是自带的，不需要再写很多。而twisted集成rabbitMQ就需要用到pika，需要写一些东西才行。</p>
<p>redis用来做celery的task记录备份数据库，可有可无。</p>
<p>nginx,uwsgi,django不用介绍，就那些功能</p>
<p>最后还要使用JMeter来进行压力测试</p>
<h3 id="Let’s-do-it"><a href="#Let’s-do-it" class="headerlink" title="Let’s do it"></a>Let’s do it</h3><p>其实这个项目这样理一下，还是挺清晰的。</p>
<p>django就这么搭建，uwsgi和nginx就这么配置。</p>
<p>celery是最近重新好好看了文档之后又拾起来的东西，之前没有好好地用过它，只是知道它好像可以做异步操作而已。</p>
<h4 id="celery"><a href="#celery" class="headerlink" title="celery"></a>celery</h4><p><a href="http://docs.celeryproject.org/en/latest/index.html" target="_blank" rel="noopener">celery</a>在介绍中就写了Broker，很明显他也是用消息队列来做进程间通信的。</p>
<p>celery对django有非常好的支持，具体的配置就要看<a href="http://docs.celeryproject.org/en/latest/django/index.html" target="_blank" rel="noopener">这里</a></p>
<p>这里来一段假装是发送短信的异步操作，print这个地方改成一个向SMS网关发送请求的代码，就可以做到发送短信了。因为django的view里面的处理函数需要返回一个response，<br>但是django自带的发送网络请求的函数都是同步的，所以用了celery就可以很快速的返回一个response给客户端，在此同时再去发送短信，这就不会导致一个http请求产生多方等待的问题。</p>
<p>tasks.py中定义任务:</p>
<pre><code>@shared_task
def send_sms(number, code):
    print &quot;sending sms to {} with code {}&quot;.format(number, code)
</code></pre><p>view.py中调用:</p>
<pre><code>@csrf_exempt
@require_POST
def send_sms(request):
    parameter = request.POST
    tasks.send_sms.delay(parameter[&quot;code&quot;], random.randint(1000, 9999))
    return JsonResponse({&quot;status&quot;: &quot;succeed&quot;})
</code></pre><p>配置的话，还挺重要的，我搞了一个celeryConfig.py，因为最后会涉及多个服务器一起部署，各自的参数会不一样，所以用一个外置文件来配置，很舒服(要把它gitignore了)</p>
<p>celeryConfig.py:</p>
<pre><code>from __future__ import absolute_import

broker_url = &apos;amqp://***:***@10.139.***.***:5672/myvhost&apos;
result_backend = &apos;redis://10.139.***.***:6379/0&apos;

task_serializer = &apos;json&apos;
result_serializer = &apos;json&apos;
accept_content = [&apos;json&apos;]
enable_utc = True


result_expires = 60
</code></pre><p>这样配置rabbitMQ和redis的服务器路径就很方便了。</p>
<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>上面说到的celery用到了10.139.***这样的内网ip，没错，现在多台服务器是共用一个redis的，所以需要配置redis让他可以对<code>外</code>开放</p>
<p>网上很多都说去掉bind 127.0.0.1，关闭protect-mode就好，但是我觉得这个方法并不好，因为直接去掉这一行，会向全网开放，而我只想在内网开放，所以只要把</p>
<pre><code>bind 127.0.0.1
</code></pre><p>改为</p>
<pre><code>bind 10.139.*** 127.0.0.1
</code></pre><p>就好了。</p>
<p>但是这样运行起来说不定还是不行，可能会”could not connect”，因为linux还没有把这个端口对外开放。使用这个明令把6379端口给开了</p>
<pre><code>/sbin/iptables -I INPUT -p tcp --dport 6379 -j ACCEPT
</code></pre><p>然后保存一下</p>
<pre><code>/etc/rc.d/init.d/iptables save
</code></pre><p>这样应该就ok了</p>
<p>某天晚上想给别人装个逼，打开终端一看，redis跪了。之后发现redis只要运行一段时间就跪了，而且杀不掉，只能重启。之后回到寝室看了报错内容</p>
<pre><code>Failed opening the RDB file dump.rdb (in server root dir /*****) for saving: Permission denied
</code></pre><p>其实问题很简单，只要把这句话里面的路径的文件的权限给了就行，就会自动恢复。</p>
<h4 id="nginx-uwsgi-django"><a href="#nginx-uwsgi-django" class="headerlink" title="nginx uwsgi django"></a>nginx uwsgi django</h4><p>这三个东西可以说是用的很熟悉了的～</p>
<p>不过这次想要玩点儿新花样。nginx和uwsgi之间使用socket来通信，而不是直接端口映射</p>
<p>uwsgi.ini:</p>
<pre><code># mysite_uwsgi.ini file
[uwsgi]

# Django-related settings
# the base directory (full path)
chdir           = /***
# Django&apos;s wsgi file
wsgi-file          = httpServer/wsgi.py
# the virtualenv (full path)
home            = /***/venv

master          = true

processes       = 10
# the socket (use the full path to be safe
socket          = /***/advServer.sock

chmod-socket    = 664
uid = www-data
gid = www-data

vacuum          = true

workers=24
listen=65535
</code></pre><p>启动之后，nginx访问这个socket总是说permission denied，即便使用的sudo也不行。后来查到资料说，要他们有相同的user和group才行。但是我明明在ini中已经设置了和nginx相同的user和group，却还是报错。</p>
<p>于是最后我只能开大招了：</p>
<pre><code>sudo chown www-data:www-data /***/advServer.sock
</code></pre><p>真的有效</p>
<h4 id="rabbitMQ"><a href="#rabbitMQ" class="headerlink" title="rabbitMQ"></a>rabbitMQ</h4><p>先说说Mac安装了rabbitMQ之后会出现的一个很小很小的问题吧～</p>
<p>运行了./rabbitmq-server之后没反应，过了一会儿提示</p>
<pre><code>error:epmd error for host ******: timeout
</code></pre><p>这个很简单，只要把这个<strong>*</strong>加入host就好了</p>
<p>修改/etc/hosts，增加：</p>
<pre><code>127.0.0.1 *****
</code></pre><p>再试即可！</p>
<h3 id="Pause"><a href="#Pause" class="headerlink" title="Pause"></a>Pause</h3><p>今天先整理到这里，明天再把twisted，pika部分的内容整理出来！</p>
<p>睡觉～</p>

      
    </div>
    
  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/hexosource/categories/programming/">编程</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/hexosource/tags/python/">Python</a>
    </span>
    

    </div>

    
  </div>
  
    
    
  
</article>
   
    <div id="toc" class="toc-article ">
    <div class="toc-title">目录</div>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Context"><span class="toc-number">1.</span> <span class="toc-text">Context</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan"><span class="toc-number">1.1.</span> <span class="toc-text">Plan</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Let%E2%80%99s-do-it"><span class="toc-number">2.</span> <span class="toc-text">Let’s do it</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#celery"><span class="toc-number">2.1.</span> <span class="toc-text">celery</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#redis"><span class="toc-number">2.2.</span> <span class="toc-text">redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx-uwsgi-django"><span class="toc-number">2.3.</span> <span class="toc-text">nginx uwsgi django</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rabbitMQ"><span class="toc-number">2.4.</span> <span class="toc-text">rabbitMQ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pause"><span class="toc-number">3.</span> <span class="toc-text">Pause</span></a></li></ol>
</div>


  

	<!-- async load  -->
	<script>
			function async(u, c) {
				var d = document, t = 'script',
						o = d.createElement(t),
						s = d.getElementsByTagName(t)[0];
				o.src = u;
				if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
				s.parentNode.insertBefore(o, s);
			}
	</script>
	<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
	<script>
			async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
					anchors.options = {
						visible: 'hover',
						placement: 'left',
						// icon: '#'
					};
					anchors.add().remove('.article-title').remove('.subheading').remove('.sidebar-container h5');
			})
	</script>
	<style>
			/* place left on bigger screen */
			@media all and (min-width: 800px) {
					.anchorjs-link{
							position: absolute;
							left: -0.75em;
							font-size: 1.1em;
							margin-top : -0.1em;
					}
			}
	</style>




<!-- UY BEGIN -->
	<div id="gitment-container"></div>
	<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
	<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
	<script src="/hexosource/js/web-pinyin.js"></script>
	<script>
		function toUnicode(s){ 
			return s.replace(/([\u4E00-\u9FA5]|[\uFE30-\uFFA0])/g,function(){
			return "\\u" + RegExp["$1"].charCodeAt(0).toString(16);
			});
		}
		var title = '厉害一些的服务器设计(1)'
		var GitHub_id = 'Boseny'
		var client_id = 'f40c67d0359a2646d2b1'
		var client_secret = '1cbedbd1a1a2e4b42901aee3d7afe1856c1b7e2d'
		var repo = 'boseny.me'
		var gitment = new Gitment({
		// id: '页面 ID', // 可选。默认为 location.href
		// id:"11" ,
		id: title,
		title: title,
		owner: GitHub_id,//'你的 GitHub ID',
		repo: repo,//'存储评论的 repo',
		oauth: {
			client_id: client_id,//'你的 client ID',
			client_secret: client_secret,//'你的 client secret',
		},
		})
		gitment.render('gitment-container')
	</script>
<!-- UY END -->




            </main>
          </div>
        </div>
       
    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/BosenY/Lap" target="_blank">Lap</a>
    <br/><span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
    </br>
    
      
        &copy; 2023 Viking Warlock
      
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92842840-1', 'auto');
    ga('send', 'pageview');

</script>


  </div>

</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  <script src="https://unpkg.com/draw-something/dist/draw.min.js"></script>
  <script>
    let maxNum = Number.parseInt('10')
    let iconText = '❤'
    let color = 'red'
    new Draw({maxNum, iconText, color})
  </script>

<script src="/hexosource/js/index.js"></script>
<script src="/hexosource/js/search.js"></script>

</body>
</html>