<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="VikingWarlock&#39;s daily life and develop experience">
    

    <!--Author-->
    
        <meta name="author" content="Viking Warlock">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="VikingWarlock"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="VikingWarlock&#39;s daily life and develop experience" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="VikingWarlock"/>

    <!--Type page-->
    
        <meta property="og:type" content="website" />
    

    <!--Page Cover-->
    

    
        <meta name="twitter:card" content="summary" />
    
    
    

    <!-- Title -->
    
    <title>page - VikingWarlock</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 5.4.2"></head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
            <h1 id="main-title" class="title">VikingWarlock</h1>
        
    </div>
</header>

        <section class="main">
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20171001-scan-code-to-login-1.html">
                扫码登录(1)
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-10-01</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>前天睡醒之前,隐隐约约的梦到了扫码登录的实现方案,虽然这个扫码登录已经有很多很多很多人实现过了,而且说不定还有了框架(我没有搜索过),但是既然我在梦里想过了一遍,那还是不要辜负自己,把它做出来看看吧～</p>
<h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><p>扫码登录:网页上显示个二维码,用登录过的app扫描一下,然后网页上就显示登陆成功</p>
<p>所以需要: 网页一个、app一个、服务器一个</p>
<p>网页用了<a href="http://jquery.com/" target="_blank" rel="noopener">jquery</a>和<a href="https://github.com/jeromeetienne/jquery-qrcode" target="_blank" rel="noopener">jquery-qrcode</a>两个框架.以前做艾米奇定位鞋的时候,用到了很多的二维码,当时把二维码图片文件存在了服务器的本地,我觉得比较难过,因为这次我没有服务器,所有的一切都在我的小电脑中,所以这次就打算让客户端自己去根据字符串生成QRCode了</p>
<p>服务器依然是<a href="https://www.djangoproject.com/" target="_blank" rel="noopener">Django</a>,用了一下<a href="http://www.celeryproject.org/" target="_blank" rel="noopener">Celery</a>(我假装做了一个发送短信验证码的异步操作),<a href="https://redis.io/" target="_blank" rel="noopener">Redis</a>(Celery需要的).只配了nginx,没有配uwsgi,因为我想动态的看看服务器运行起来的一些log,用了uwsgi我就不方便调试了～</p>
<p>App嘛,必然又是iOS,我做得快一些～,用了几个很基础的框架,AFNetworking、<a href="https://github.com/hackiftekhar/IQKeyboardManager" target="_blank" rel="noopener">IQKeyBoardManager</a></p>
<h3 id="Solution-in-Dream"><a href="#Solution-in-Dream" class="headerlink" title="Solution in Dream"></a>Solution in Dream</h3><p>在梦里,我是打算在服务器中建立QRCode和一个session的关系,然后App登录过的Session可以将QRCode对应的Session也变为已登陆状态,然后网页端的Session就变成了已登录状态,然后就扫码登录成功了.</p>
<h3 id="For-Security"><a href="#For-Security" class="headerlink" title="For Security"></a>For Security</h3><p>在整套工作过程中,哪些部分可能会出现安全风险呢？</p>
<p>要分析这个问题,可能需要先整理一下,什么情况下,网页端可以登陆成功.下面是根据功能得到的最显而易见的一组条件</p>
<pre><code>1. 网页端有QRCode
2. App扫描了QRCode,并且同意登陆
</code></pre><p>这意思是,网页问服务器要一个QRCode,然后在那儿一个劲的问服务器,<code>我这个QRCode通过登录了嘛？</code></p>
<p>App扫描了QRCode,告诉服务器,<code>我是XXX,我扫描了这个QRCode,我要登录</code></p>
<p>然后服务器就告诉了网页端,<code>你登录了</code></p>
<p>这样的做法,我觉得大概也是可行的,只不过QRCode这东西可能攻击者伪造一下,就撞到别的已经通过的QRCode,然后他就幸运的登录成功了呢！</p>
<p>所以我想,应该还是要多搞一些规则才行～</p>
<p>然后就建立了这样一个模型</p>
<pre><code>class LoginQRCode(models.Model):
    # 显示的二维码
    code = models.CharField(max_length=255)
    # 传递参数时必备参数
    token = models.UUIDField()
    # session中对应的uuid
    session_token = models.UUIDField()
    # 创建时间(更新时间)
    timestamp = models.DateTimeField()
    # 登陆后记录一下这个二维码对应的用户
    user_id = models.UUIDField(blank=True, null=True)
    # 是否通过
    status = models.BooleanField(default=False)

    def get_fetch_qrcode_response(self):
        return {&quot;code&quot;: self.code, &quot;token&quot;: str(self.token), &quot;timestamp&quot;:get_update_time(self.timestamp)}
</code></pre><p>在获取QRCode的时候</p>
<pre><code>def ask_for_login_qrcode(request):
    if &quot;login&quot; in request.session:
        if request.session[&quot;login&quot;] is True:
            return JsonResponse({&quot;msg&quot;: &quot;already login&quot;, &quot;status&quot;: 1}, status=200)
    if &quot;session_uuid&quot; in request.session:
        old_uuid = request.session[&quot;session_uuid&quot;]
        old_qrcode_record = fetch_qrcode_record_with_session(old_uuid)
        if qrcode_record_is_expired(old_qrcode_record) is True:
            record = generate_new_qrcode_record_for_request(request)
            return JsonResponse({&quot;msg&quot;: &quot;succeed&quot;, &quot;status&quot;: 0, &quot;data&quot;: record.get_fetch_qrcode_response()}, status=200)
        else:
            return JsonResponse({&quot;msg&quot;: &quot;succeed&quot;, &quot;status&quot;: 0, &quot;data&quot;: old_qrcode_record.get_fetch_qrcode_response()},
                                status=200)
    else:
        record = generate_new_qrcode_record_for_request(request)
        return JsonResponse({&quot;msg&quot;: &quot;succeed&quot;, &quot;status&quot;: 0, &quot;data&quot;: record.get_fetch_qrcode_response()}, status=200)
</code></pre><p>意思差不多就是,一个session会产生一个token,一个code,一个session_token,其中session_token会对应记录在session中,以便服务器根据session来判断某个token是否是该会话产生的,(也算是防了一下跨站攻击？),app根据扫描二维码,得到code,将code作为参数告诉服务器,<code>我要这个code登录</code>,然后服务器对这个qrcode纪录进行授权,之后检查到这个session的时候,将这个session标记为已登录,整个流程就走完了～</p>
<p>所以处理App扫码之后做的请求是</p>
<pre><code>@csrf_exempt
@require_POST
@pass_auth
@require_parameter([&quot;code&quot;])
def allow_the_qrcode_login(request):
    code = request.POST[&quot;code&quot;]
    user = get_user_from_response_session(request)
    qr_record = fetch_qrcode_record_with_code(code)
    if user is not None and qr_record is not None:
        if qr_record.user_id is not None:
            return JsonResponse({&quot;msg&quot;: &quot;expired&quot;, &quot;status&quot;: -1}, status=400)
        qr_record.user_id = user.user_uuid
        qr_record.status = True
        qr_record.save()
        return JsonResponse({&quot;msg&quot;: &quot;succeed&quot;, &quot;status&quot;: 0}, status=200)
    return JsonResponse({&quot;msg&quot;: &quot;code not existed&quot;, &quot;status&quot;: -400}, status=400)
</code></pre><p>这里用了两个自己写的修饰器用了确定session是登录过的,并且包含了参数”code”～</p>
<p>当然还有很多个工具方法,看名字大概也知道他是什么意思吧～</p>
<p>最后是刷新登录状态的接口</p>
<pre><code>@csrf_exempt
@require_POST
@require_parameter([&quot;token&quot;])
def checking_login_status(request):
    token_uuid = request.POST[&quot;token&quot;]
    qrcode_entity = fetch_qrcode_record_with_token(token_uuid)
    if qrcode_entity is None:
        return JsonResponse({&quot;msg&quot;: &quot;bad request&quot;, &quot;status&quot;: -403}, status=400)
    if &quot;login&quot; in request.session:
        if request.session[&quot;login&quot;] is True:
            if request.session[&quot;session_uuid&quot;] == qrcode_entity.session_token:
                return JsonResponse({&quot;msg&quot;: &quot;pass&quot;, &quot;status&quot;: 0}, status=200)
            else:
                return JsonResponse({&quot;msg&quot;: &quot;token error&quot;, &quot;status&quot;: -1}, status=403)
        elif qrcode_entity.status is True and request.session[&quot;session_uuid&quot;] == str(qrcode_entity.session_token):
            request.session[&quot;login&quot;] = True
            request.session[&quot;user_id&quot;] = str(qrcode_entity.user_id)
            return JsonResponse({&quot;msg&quot;: &quot;pass&quot;, &quot;status&quot;: 0}, status=200)
        elif qrcode_record_is_expired(qrcode_entity):
            return JsonResponse({&quot;msg&quot;: &quot;code is expired,please refresh it&quot;, &quot;status&quot;: -1}, status=200)
    return JsonResponse({&quot;msg&quot;: &quot;waiting&quot;, &quot;status&quot;: 1}, status=200)
</code></pre><p>这段我也懒得解释了,反正要改了……</p>
<h3 id="Have-a-break"><a href="#Have-a-break" class="headerlink" title="Have a break"></a>Have a break</h3><p>这一篇先写这么多,下一篇会讲扫码App的故事(网页端会在很后面讲,因为这个版本网页端和服务端存在一个轮训操作,这个操作效率很低下,我打算在后面加入了websocket之后,再来一起讲网页端～)</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170928-socket-server-and-client.html">
                Socket
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-09-28</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>这个故事从三年前开始说起.</p>
<p>那时老师让我搞Android的一个防伪项目(精益防伪),就是那个用Android的NFC功能来鉴别一个酒是否是假冒伪劣的,也是那个项目让我认识了卢师兄(在华为可厉害了呢).</p>
<p>那时的我只用过http来进行网络请求,没有用过socket来进行数据交互.</p>
<p>由于项目需要,那时候就临时在Android上搞了一波socket通信.</p>
<p>第一次做Android就要碰Socket还是蛮困难的(虽然我已经搞了两年iOS,但是iOS和Android毕竟还是不一样的,而且我还是个孩子),因为界面没做过,java也不是很熟悉,甚至连Android的手机都没有用过. 由于时间比较紧张,所以界面就请望神帮我画了,我去写了数据处理和Socket通信. 那也是第一次我知道了Android上面有很严格的线程限制. 在iOS上的主线程中调用网络,会堵塞,卡在那儿,等到请求完了,就会恢复;不过在android上面,主线程碰一下网络竟然就异常了～(真凶)</p>
<h3 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h3><p>Socket其实不应该和http分开说,因为http只是socket的一种扩展罢了,要进行网络通信,总是离不开Socket的.http只不过是在socket上面进行了很多复杂的封装罢了(很复杂).</p>
<p>socket,翻译过来就是,插座.打个比方就是,我要和你收发数据,就把数据线插到你的插孔里面,然后我们就在这根线里面交流.一个网络节点可以有很多的插座孔,所以也就可以同时和很多很多人一起交流信息.而http是插上了插座,发一句话,收一句话,然后就把插头拔掉了(连接结束了)好处就是服务器和客户端不用一直维护一个连接,缺点嘛,这是一个短连接,下一次想要进行网络请求还需要把TCP的握手流程走一遍,而且是单向操作(只能客户端找服务器麻烦,服务器永远无法主动找客户端麻烦)</p>
<h3 id="Now"><a href="#Now" class="headerlink" title="Now"></a>Now</h3><p>三年前的旧事讲完了,该说说这次的故事了</p>
<p>这次我们的产品中会涉及用到socket传输文件,这比三年前那个要求更高了一些,因为文件还是蛮大的,之前每次的数据也就十几个字节(128位)(NFC标签儿本来也存不了多少内容)</p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><p>先从服务器开始说起吧！由于这个socket传输只会一对一的传输,所以这个服务器根根本本不用考虑并发和异步什么的东西,所以</p>
<p><code>就用Python做个简单的socket服务器吧！</code></p>
<h5 id="code"><a href="#code" class="headerlink" title="code"></a>code</h5><pre><code>import threading
import SocketServer
import datetime
import time

BUFFER_SIZE = 4096


class ThreadedTCPRequestHandler(SocketServer.BaseRequestHandler):
    t = None
    wantDisconnect = False

    def handle(self):
        if self.t is None:
            self.t = datetime.datetime.now()
            time_interval = 0
        else:
            time_interval = (datetime.datetime.now() - self.t).seconds
        while time_interval &lt; 60 and not self.wantDisconnect:
            data = self.request.recv(BUFFER_SIZE)
            if data:
                self.t = datetime.datetime.now()
                print &quot;prepare to send file&quot;
                f = open(str(data), &apos;rb&apos;)
                l = f.read(BUFFER_SIZE)
                while l:
                    self.request.send(l)
                    print(&quot;sending (%x)&quot;, l)
                    l = f.read(BUFFER_SIZE)
                    time.sleep(1/20)
                time.sleep(1)
                self.request.sendall(&quot;\nsending ok&quot;)
                f.close()
            else:
                print threading.currentThread().name, &quot; no data&quot;
                break

    def setup(self):
        print threading.currentThread(), &quot; start&quot;
        self.t = datetime.datetime.now()

    def finish(self):
        self.wantDisconnect = True
        print threading.currentThread(), &quot; end&quot;


class ThreadedTCPServer(SocketServer.ThreadingMixIn, SocketServer.TCPServer):
    pass


HOST, PORT = &quot;0.0.0.0&quot;, 55555

server = ThreadedTCPServer((HOST, PORT), ThreadedTCPRequestHandler)
server.serve_forever()
</code></pre><p>我直接在服务器的文件目录下放了几个图片文件用来做测试的～</p>
<p>这差不多基本上是直接从Python的SocketServer<a href="https://docs.python.org/2/library/socketserver.html#" target="_blank" rel="noopener">文档</a>中抄来的</p>
<p>一个多线程的socket服务器就是这么方便</p>
<p>其中<code>setup()</code>和<code>finish()</code>没什么太大的意思,反正就是又一个socket连接进来了和对方主动断开后会做的事情</p>
<p>关键的操作都在handle中！</p>
<p>先贴一下官方的解释：</p>
<pre><code>handle()

    This function must do all the work required to service a request. The default implementation does nothing. Several instance attributes are available to it; the request is available as self.request; the client address as self.client_address; and the server instance as self.server, in case it needs access to per-server information.

    The type of self.request is different for datagram or stream services. For stream services, self.request is a socket object; for datagram services, self.request is a pair of string and socket.
</code></pre><p>就是说有请求进来了,就会在这里<code>中断</code> ,aka “回调”(但我觉得用中断好像更加形象生动)</p>
<p>self.request将获取到socket实例,有了这个socket实例我们就可以读读写写了</p>
<p>这里的代码是传入的数据代表的是文件,服务器根据文件名,把数据回传回去,就是这么简单,看看效果图</p>
<p><img src="http://vvk.ixuanlun.com/socket_server_running.png" alt="效果图"></p>
<p>密集恐惧症了吧？哈哈哈～在服务器把发送的数据打印出来,可以方便调试,(肉眼)检查数据有没有收完收对……</p>
<p>等下,<code>time.sleep(1/20)</code>这个东西有啥子用处？</p>
<p>我担心发送的太快接收端粘包,所以就稍微给一点点儿延迟,缓解一下压力,不过实测下来貌似是我多虑了～</p>
<h4 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h4><p>以我的尿性,客户端必然是从iOS开始搞的～</p>
<p>目标很简单,连接服务器,发个文件名,一个劲的收数据,最后显示<code>效果</code></p>
<p><img src="http://vvk.ixuanlun.com/socket_ios_running.png" alt="iOS效果"></p>
<p>略～</p>
<h5 id="Doing"><a href="#Doing" class="headerlink" title="Doing"></a>Doing</h5><p>多年前在CocoaPods上面看到了<a href="https://github.com/robbiehanson/CocoaAsyncSocket" target="_blank" rel="noopener">CocoaAsyncSocket</a>,今天终于要动手搞一搞了！好激动</p>
<p>一般大家在github的README.md里面都要把自己的库的用法好好的解释一遍,让访问者眼前一亮,然后送出Star,不过这个库真牛逼,README.md里面装了整整一页的逼！</p>
<p>然后我去wiki里面看,竟然还给了好多个链接,一时半会儿还找不到他的使用方法,不过我看了<a href="https://github.com/robbiehanson/CocoaAsyncSocket/wiki/CommonPitfalls" target="_blank" rel="noopener">CommonPitfalls</a>这个板块,我觉得写的很屌,如果我前面的那些关于socket的废话你没看懂的话,可以去这个链接里面再看看.里面讲了不少误区,坑,雷……</p>
<p>好吧,其实它真正的用法在<a href="https://github.com/robbiehanson/CocoaAsyncSocket/wiki/Intro_GCDAsyncSocket" target="_blank" rel="noopener">Intro_GCDAsyncSocket</a>里面</p>
<p>教了连接动作,连接结果,读操作,写操作</p>
<p>贴代码</p>
<pre><code>- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.
    socket=[[GCDAsyncSocket alloc]initWithDelegate:self delegateQueue:dispatch_get_main_queue()];
    NSError *error;
    buf=[NSMutableData data];
    [socket connectToHost:@&quot;192.168.199.131&quot; onPort:55555 error:&amp;error];
}

-(IBAction)send_action:(id)sender{
    [socket writeData:[self.commandField.text  dataUsingEncoding:NSASCIIStringEncoding] withTimeout:5.f tag:12345];
}

- (void)socket:(GCDAsyncSocket *)sock didConnectToHost:(NSString *)host port:(uint16_t)port{
    NSLog(@&quot;socket is connected&quot;);
    [self.sendButton setEnabled:YES];
}

- (void)socket:(GCDAsyncSocket *)sock didReadData:(NSData *)data withTag:(long)tag{
    NSLog(@&quot;[%ld]Did receive Completely %@,(%ld)&quot;,tag,data,data.length);
    self.console.text=[NSString stringWithFormat:@&quot;%@\n%@&quot;,data,self.console.text];
    UIImage *image=[UIImage imageWithData:data];
    self.imageView.image=image;
}

- (void)socket:(GCDAsyncSocket *)sock didReadPartialDataOfLength:(NSUInteger)partialLength tag:(long)tag{
    NSLog(@&quot;[%ld]receive (%lu)*1024 bytes&quot;,tag,partialLength);
}

- (void)socket:(GCDAsyncSocket *)sock didWriteDataWithTag:(long)tag{
    if (tag==12345){
        [sock readDataToData:[@&quot;\nsending ok&quot; dataUsingEncoding:NSASCIIStringEncoding] withTimeout:60.f tag:119];
    }
}

- (void)socketDidCloseReadStream:(GCDAsyncSocket *)sock{
    NSLog(@&quot;socket closed&quot;);
    [self.sendButton setEnabled:NO];
}

- (void)socketDidDisconnect:(GCDAsyncSocket *)sock withError:(nullable NSError *)err
{
    NSLog(@&quot;socket disconnect&quot;);
    NSLog(@&quot;buf is %@&quot;,buf);
    [self.sendButton setEnabled:NO];
}
</code></pre><p>这代码好像蛮长的～</p>
<p>其中有partial的回调方法都是接收不完整的时候会做的事儿</p>
<p>Socket本来就是全双工的,就是可以一边儿发送一边儿接收,不过这现在给我做成了个半双工的了,所以我在读取的时候设置了一个结束条件<code>\nsending ok</code>,接收到了这个的时候,就会停止.</p>
<h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><p>android上面我想装逼,不用框架,直接用socket来撸,写的还是蛮痛苦的</p>
<p>先只贴代码,先不做解释了,因为,写的不是特别好……等到优化好了,再写一篇新的,好好解释一番～</p>
<p>先搞个center</p>
<pre><code>public class SocketCenter {
    SocketEntity socket;
    Handler handler = new Handler();
    Thread socket_thread;
    Handler network_handler;
    public void setup() {
        EventBus.getDefault().register(this);
        socket_thread=new Thread(new Runnable() {
            @Override
            public void run() {
                Looper.prepare();
                network_handler=new Handler();
                Looper.loop();
            }
        });
        socket_thread.start();
    }
    public void connect_server() {
        network_handler.post(new Runnable() {
            @Override
            public void run() {
                socket = new SocketEntity(&quot;192.168.199.131&quot;, 55555, handler);
                socket.connect();
            }
        });
    }
    public void disconnect() {
    }
    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onEvent(SocketEvent event) {
        if (event.getName().equalsIgnoreCase(EventConstant.Socket_Connected)) {
            network_handler.post(new Runnable() {
                @Override
                public void run() {
                    socket.ask_for_file(&quot;img1.jpg&quot;, &quot;\nsending ok&quot;);
                }
            });
        }
    }
}
</code></pre><p>再把实例搞出来</p>
<pre><code>public class SocketEntity {
    private Socket socket;
    String address;
    int port;
    BufferedReader reader;
    BufferedWriter writer;
    byte[] temp_data;
    ArrayList&lt;byte[]&gt; received_queue;
    WeakReference&lt;Handler&gt; handler_reference;
    Thread async_thread;
    SocketEntity(String address, int port, Handler handler) {
        socket = new Socket();
        handler_reference = new WeakReference&lt;Handler&gt;(handler);
        this.address = address;
        this.port = port;
        received_queue = new ArrayList&lt;&gt;();
        async_thread = new Thread();
    }
    Socket getSocket() {
        return socket;
    }
    void connect() {
        Log.e(&quot;SocketUtil&quot;, &quot;Start Connect&quot;);
        if (socket != null) {
            if (!socket.isConnected()) {
                try {
                    socket.connect(new InetSocketAddress(address, port), 5000);
                    writer = new BufferedWriter(new OutputStreamWriter(socket.getOutputStream()));
                    reader = new BufferedReader(new InputStreamReader(socket.getInputStream()));
                    SocketEvent event = SocketEvent.connectEventInstance();
                    EventBus.getDefault().post(event);
                } catch (IOException e) {
                    e.printStackTrace();
                    SocketEvent event = SocketEvent.failBaseEventInstance(-200);
                    EventBus.getDefault().post(event);
                    writer = null;
                    reader = null;
                }
            }
        }
    }
    void disconnect() {
        if (socket != null) {
            if (socket.isConnected()) {
                try {
                    socket.close();
                    writer.close();
                    reader.close();
                    writer = null;
                    reader = null;
                } catch (IOException e) {
                    e.printStackTrace();
                    SocketEvent event = SocketEvent.failBaseEventInstance(-400);
                    EventBus.getDefault().post(event);
                    if (!socket.isConnected()) {
                        writer = null;
                        reader = null;
                    }
                }
            }
        }
    }
    void ask_for_file(String filename, String endPoint) {
        send_command(filename);
//        receive_data_until(endPoint.getBytes());
        receive_data(endPoint.getBytes());
    }
    private void receive_data(byte[] endpoint) {
        try {
            char[] buf = new char[1024];
            int total = 0;
            boolean isEnd = false;
            String s = &quot;&quot;;
            while (!isEnd) {
                int length = reader.read(buf, 0, 1024);
                isEnd = (length == -1);
                if (length &gt; 0) {
                    char[] valid_data = Arrays.copyOfRange(buf, 0, length);
                    String string = String.valueOf(valid_data);
                    s=s+string;
                    isEnd = string.contains(new String(endpoint));
                    if (!isEnd) {
                        total += length;
                    } else {
                        total += length;
                        total -= endpoint.length;
                    }
                    Log.e(&quot;Socket_Received&quot;, String.valueOf(HexUtil.encodeHex(string.getBytes())));
                    Log.e(&quot;String is &quot;, string);
                }
            }
            Log.e(&quot;Socket_Received&quot;, &quot;Total Size is &quot; + total + &quot; bytes&quot;);
//            temp_data=s.getBytes();
            temp_data=Arrays.copyOfRange(s.getBytes(),0,total);
            Log.e(&quot;Socket_Received&quot;, &quot;Total binary Size is &quot; + temp_data.length + &quot; bytes&quot;);
            SocketEvent event= SocketEvent.fileReceivedEventInstance(temp_data);
            EventBus.getDefault().post(event);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    private void receive_data_until(byte[] ends) {
        try {
            byte[] temp = null;
            byte[] temp_buffer = null;
            while (ends != temp) {
                String line = reader.readLine();
                byte[] bytes = line.getBytes();
                Log.e(&quot;Socket_Received&quot;, String.valueOf(HexUtil.encodeHex(bytes)));
                int length = ends.length;
                if (bytes.length &gt;= length) {
                    temp = Arrays.copyOfRange(bytes, (bytes.length - length), bytes.length);
                    temp_buffer = line.getBytes();
                } else if (temp_buffer != null) {
                    int rear = bytes.length;
                    int front = ends.length - rear;
                    if (temp_buffer.length &gt; front) {
                        temp = new byte[ends.length];
                        for (int i = 0; i &lt; front; i++) {
                            temp[i] = temp_buffer[temp_buffer.length - front + i];
                        }
                        for (int i = 0; i &lt; rear; i++) {
                            temp[front + i] = bytes[i];
                        }
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    private void send_command(byte[] command) {
        String cmd = Arrays.toString(command);
        send_command(cmd);
    }
    private void send_command(String command) {
        if (socket != null &amp;&amp; socket.isConnected()) {
            try {
                Log.e(&quot;SocketUtil&quot;, &quot;Send &quot; + command);
                writer.write(command);
                writer.flush();
            } catch (IOException e) {
                e.printStackTrace();
                SocketEvent event = SocketEvent.failBaseEventInstance(-1);
                EventBus.getDefault().post(event);
            }
        }
    }
}
</code></pre><p>这里面有很多的问题,不过还是成功的做到了连接,发送指令,接收数据,由于最后<code>BitmapFactory.decodeByteArray</code>存在一些问题,估计和接收的数据有关系,所以没有效果图……(难过)</p>
<h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>先写这么多了,等我下次优化完了,说不定就会有更深入的理解,更好的代码,更加出色的性能,到时候再贴出来留作纪念！</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170822-app-code-sign.html">
                突变的SHA1
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-08-22</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>故事从两个低分评价开始.</p>
<p>那一天,Google Play上面,Cycplus 007突然惊现两个低分评价,除了一个翻译的小问题之外,他们还异口同声的反应到,他们的报警界面上的Google Map里面空白一片了,什么都不显示.</p>
<p>在全球发售之前,我们特地把样品寄到了全球各地(的某些地方),进行测试,以保证我们的产品是可以在海外正常工作的.</p>
<p>而且这两个用户都是波兰人,难道,波兰的Google也被禁了？hahaha</p>
<p>那是不可能的,他们可是从Google Play上面下载的App</p>
<h3 id="Google-and-Android"><a href="#Google-and-Android" class="headerlink" title="Google and Android"></a>Google and Android</h3><p>突然,我陷入了恐慌.在很久很久之前我担心的一个问题,不会灵验了吧！</p>
<p>我们知道,Android是Google的,但是Android上面又可以没有google的东西(国产手机们基本上都没有Google Play套件),那Google Map作为Android的原生地图,会不会在那些缺少Google套件的手机上无法运行呢？</p>
<p>毕竟,iOS是可以直接使用原生地图的,使用原生地图还可以节省不少的空间呢,因为原生的地图空间,所需要的容量早就算在系统里面了～</p>
<p>所以我就很担心,会不会只有安装了Google Play套件的手机才可以使用Google Play～</p>
<p>操作了一番,竟然是真的.</p>
<p><img src="http://vvk.ixuanlun.com/google_map_not_work.jpg" alt="GoogleMapNotWorking"></p>
<p>不过回头一想,他们是Google Play上面下载的App,难道会没有Google Play套件？</p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>我自信满满地再一次打开了app,看着正常运行的Google Map,陷入了沉思.</p>
<p>我不明白为什么我就可以运行</p>
<p>然后我就删掉了本地的App,从Google Play上面再下载了一份,运行起来,</p>
<p><code>竟然真的是空白！</code></p>
<p>吓得我突然之间手忙脚乱,手足无措,明明之前都是可以使用的,突然之间怎么就坏掉了！</p>
<p>我连接上数据线,查看catlog,竟然发现Google Map说我的签名错了！</p>
<p>我急忙登上Google Console,并且用keytool查看了我打包时候使用的Sha1:</p>
<pre><code>1B:xxxxxxx
</code></pre><p>在Google Console上面登记着的:</p>
<pre><code>1B:xxxxxxx
</code></pre><p>catlog里面写着我使用的Sha1:</p>
<pre><code>ED:xxxxxxx
</code></pre><h4 id="What-the-fuck"><a href="#What-the-fuck" class="headerlink" title="What the fuck?"></a>What the fuck?</h4><p>怎么,怎么会变了呢</p>
<h3 id="Google-Play-App-Signing"><a href="#Google-Play-App-Signing" class="headerlink" title="Google Play App Signing"></a>Google Play App Signing</h3><p>在Google Play的Console里面有一个菜单是<code>应用签名</code></p>
<p>在里面我惊奇的发现了两个证书：</p>
<pre><code>-应用签名证书
-上传证书
</code></pre><p>而我登记在Google Map的Console里面的正是这个上传证书,而下载安装之后显示的,是这个应用签名证书的Sha1</p>
<p>这时我恍然大悟,前几天着急更新的时候,好像是点击了一个什么<code>Google Play App Signing</code>之类的按钮,当时也没管它是干什么的,就着急的去更新软件了.</p>
<p>下面来转载一下他的官方介绍：</p>
<pre><code>Without Google Play App Signing: You sign the app with your app signing key, upload your app to Google Play, and then your app is delivered to the user.

With Google Play App Signing: You sign your app with your upload key. Then, Google verifies and removes the upload key signature. Finally, Google re-signs the app with the original app signing key you provided and delivers your app to the user.
</code></pre><p>总之他的意思大概是担心坏人得到了这个apk之后,通过各种我反正不懂的方法之后,可以得到原来签名的key</p>
<p>这会不安全,所以Google用各种我反正不懂的方法,把这个原来签名的key给去掉,换一个它自己的key,这样子就不会被坏人破解出上传APK的key,来做坏事儿了.</p>
<p>看起来确实,是稍微安全了一些呢</p>
<p>下面还介绍了可以设置的各种key,反正我(你)可能也用不到,我就不说了</p>
<p>可是</p>
<h4 id="最关键的是："><a href="#最关键的是：" class="headerlink" title="最关键的是："></a>最关键的是：</h4><h4 id="进来了-还想走？"><a href="#进来了-还想走？" class="headerlink" title="进来了,还想走？"></a>进来了,还想走？</h4><pre><code>Google Play App Signing is an optional program. If you prefer, you can continue managing your own keys.

Once you&apos;ve enrolled your app in Google Play App Signing, withdrawal is not supported. To preserve the security of your app signing keys, we don&apos;t have the ability to remove keys from the secure server.
</code></pre><p>这就很是麻烦了……因为国外我们可以在Google Play中下载,但是国内我们将安装文件放在了服务器上,供用户直接下载安装.</p>
<p>而国内这个安装文件,肯定使用的是upload key,所以,他们的Sha1是不一样的.</p>
<p>可能这个情况Google早就考虑到了,所以在Google Map的Console中,我们是可以添加好多好多个Sha1的,所以加上一个新的Sha1之后,Google Play版本的用户就可以正常使用Google Map了.</p>
<h4 id="但是"><a href="#但是" class="headerlink" title="但是"></a>但是</h4><p>百度地图没有想到这个问题,他们的配置界面只有两个Sha1可以填写,而且一个事发布饭一个是开发版.</p>
<p>这就意味着,如果开发版里面填写着我自己debug用的sha1,那么Google Play的用户或者国内用户中,至少有一方是不能使用百度地图查看他们的报警信息的</p>
<h4 id="你大概会觉得："><a href="#你大概会觉得：" class="headerlink" title="你大概会觉得："></a>你大概会觉得：</h4><p>反正外国人不会用百度地图的,就不用给他们添加到配置页面了咯</p>
<h5 id="NO"><a href="#NO" class="headerlink" title="NO"></a>NO</h5><p>我就是在国内,使用Google Play的中国人……我相信还有很多人会和我一样,因为害怕国内的商店太霸道,又不喜欢App内更新,所以我还是喜欢和App Store一样的商店.</p>
<p>于是乎,我就只能把debug的key换了下来,改成了Google play的sha1</p>
<h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>这个故事并没有涉及到什么高深的技术,但是却说明了很重要的一件事</p>
<h4 id="鼠标点慢一些！"><a href="#鼠标点慢一些！" class="headerlink" title="鼠标点慢一些！"></a>鼠标点慢一些！</h4>
        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170818-ios-image-get-color.html">
                iOS图片取色
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-08-18</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <p>上周兴冲冲的在炫轮的iOS版中加了梦寐以求的GIF制作功能,这个功能两年前我就像加,只是当时胆子不够大,觉得iOS不能从相册读取GIF,所以这个功能就一直处于被砍掉的状态.</p>
<h3 id="Not-Important"><a href="#Not-Important" class="headerlink" title="Not Important"></a>Not Important</h3><p>用UIImagePickerViewController从图库中选择一个图片,这个百度一下,教程是有很多的,就不在这个本来就不重要的地方说了.</p>
<h5 id="关键就在于如何处理选择的图片"><a href="#关键就在于如何处理选择的图片" class="headerlink" title="关键就在于如何处理选择的图片"></a>关键就在于如何处理选择的图片</h5><p>在UIImagePickerViewController的delegate的回调方法中,有个info</p>
<pre><code>- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary&lt;NSString *, id&gt; *)info
</code></pre><p>这个info可厉害了,里面有很多很多的东西</p>
<pre><code>UIKIT_EXTERN NSString *const UIImagePickerControllerMediaType
UIKIT_EXTERN NSString *const UIImagePickerControllerOriginalImage //原图 UIImage,不过GIF只有第一帧
UIKIT_EXTERN NSString *const UIImagePickerControllerEditedImage
UIKIT_EXTERN NSString *const UIImagePickerControllerCropRect
UIKIT_EXTERN NSString *const UIImagePickerControllerMediaURL     UIKIT_EXTERN NSString *const UIImagePickerControllerReferenceURL //原图的文件地址
UIKIT_EXTERN NSString *const UIImagePickerControllerMediaMetadata
UIKIT_EXTERN NSString *const UIImagePickerControllerLivePhoto
</code></pre><p>直接使用<code>UIImagePickerControllerOriginalImage</code>获取UIImage肯定是不行的,这就是一个静图,所以我们使用<code>UIImagePickerControllerReferenceURL</code>获取到这个图片的位置,然后再获取到数据,然后再解析成GIF～完美</p>
<p>于是我就用NSData获取了这个url,然后发现,这个操作得到的NSData是nil！</p>
<p>我仔细一看这个url,是<code>AssetLibrary</code>的链接,不是一个绝对路径！</p>
<p>看来需要操作AssetLibrary了……</p>
<h3 id="AssetLibrary-amp-amp-Photos"><a href="#AssetLibrary-amp-amp-Photos" class="headerlink" title="AssetLibrary &amp;&amp; Photos"></a>AssetLibrary &amp;&amp; Photos</h3><p>于是我就去Apple Developer官网找AssetLibrary的资料,吃鲸的发现,AssetLibrary已经灭绝(废弃)了！</p>
<p>这是天大的好消息啊,因为查看了其他的资料,据说AssetLibrary是非ARC的,还有一堆同步异步等乱七八糟的东西,总之就是坑很多.现在用Photos来代替,我紧张的去查询Photos,担心他要求的系统SDK比我当前部署的SDK高.</p>
<p><code>iOS 8 !</code></p>
<p>哈哈哈哈,和我当前的部署版本是一样的,这就意味着,这个版本的炫轮app的GIF功能是可以对所有用户开放的！</p>
<p>Photos依然有很多异步操作(毕竟有的图片可能是在iCloud上面的),所以我就干脆定义了一个block来</p>
<pre><code>typedef void(^LoadingAssetBlock)(NSArray * images);
</code></pre><p>我是为了获取GIF的,那么这个返回的参数给个数组,就刚刚好了～</p>
<p>下面我们来根据url获取GIF吧！</p>
<pre><code>- (void)imagesForURL:(NSURL *)url andBlock:(LoadingAssetBlock)block {
    PHFetchResult *assets= [PHAsset fetchAssetsWithALAssetURLs:@[url] options:nil]; // 1
    PHAsset *asset=[assets objectAtIndex:0]; // 2
    [[PHImageManager defaultManager] requestImageDataForAsset:asset options:nil resultHandler:^(NSData *imageData, NSString *dataUTI, UIImageOrientation orientation, NSDictionary *info) { //3
        NSData *data=imageData;
        NSString *type=[NSData sd_contentTypeForImageData:data];  //这是SDWebImage的大佬们写的
        if ([type isEqualToString:@&quot;image/gif&quot;]) {
            UIImage *img = [UIImage sd_animatedGIFWithData:data];  这也是SDWebImage的大佬们写的
            NSMutableArray *renderedImage=[NSMutableArray array];
            for (UIImage *item in img.images) {
                VKMutableImage *mutable=[VKMutableImage imageWithImage:item];
                /**
                *这里真的不重要
                */
                [renderedImage addObject:mutable];
            }
            block([NSArray arrayWithArray:renderedImage]);
        } else{
            UIImage *image=[UIImage imageWithData:imageData];
            VKMutableImage *mutable=[VKMutableImage imageWithImage:image];
                /**
                *这里真的不重要
                */
            block(@[mutable]);
        }
    }];
}
</code></pre><p>其实只要看注释 1,2,3就够了……</p>
<h3 id="They-are-not-important"><a href="#They-are-not-important" class="headerlink" title="They are not important!"></a>They are not important!</h3><p>我发现我好像跑题了,这一片的主要内容是,获取UIImage上的各个点的颜色的,然后我们使用RGB数组制作一个UIImage</p>
<p>再再介绍一下背景吧～</p>
<p>按理说上面说的这个图片操作的功能,早在炫轮刚面世的时候就存在的,为啥现在才来说这个东西呢？</p>
<p><code>因为从一开始就写错了！直到现在才发现</code></p>
<p>就当我上周兴冲冲的写完iOS的GIF制作功能之后,我就开始写android版的GIF制作功能,花了3天才终于把功能做完了！</p>
<p>正当我准备发一波朋友圈得瑟得瑟的时候,我发现了一个很严重的问题…</p>
<p><img src="http://vvk.ixuanlun.com/android_xw_gif_right.png" alt="Android GIF ScreenShot"><br><img src="http://vvk.ixuanlun.com/ios_xw_gif_error.png" alt="iOS GIF ScreenShot"></p>
<p>使用了一样的调色,为什么结果<code>不一样</code>！按照以前的习惯,我一定是会怀疑Android版本出现了问题的,可是根据原图,我总觉得,Android上面的结果好像是正确的！</p>
<p>那就意味着,发布了快<code>3</code>年的炫轮<code>iOS版App</code>存在一个致命的图像处理的问题！</p>
<h3 id="Here-we-go"><a href="#Here-we-go" class="headerlink" title="Here we go"></a>Here we go</h3><p>正片开始了～</p>
<p>经过一连串debug手法,我找到了出问题的代码位置：<code>以下是有问题的代码</code></p>
<pre><code>CGImageRef imageRef=originImage.CGImage;
CGContextRef context = newBitmapRGBA8ContextFromImage(imageRef);
size_t width = CGImageGetWidth(imageRef);
size_t height = CGImageGetHeight(imageRef);
CGRect rect = CGRectMake(0, 0, width, height);
CGContextDrawImage(context, rect, imageRef);
unsigned char *bitmapData = (unsigned char *)CGBitmapContextGetData(context);
size_t bytesPerRow = CGBitmapContextGetBytesPerRow(context);
size_t bufferLength = bytesPerRow * height;
unsigned char *newBitmap = NULL;
if(bitmapData) {
    newBitmap = (unsigned char *)malloc(sizeof(unsigned char) * bytesPerRow * height);
    if(newBitmap) {
        for(int i = 0; i +3 &lt; bufferLength;i=i+3) {
            int R=bitmapData[i];
            int G=bitmapData[i+1];
            int B=bitmapData[i+2];
            /**
            * 这里一点儿也不重要
            */
            newBitmap[i] = R;
            newBitmap[i+1]=G;
            newBitmap[i+2]=B;
            newBitmap[i+3]=255;
        }
    }
    free(bitmapData);
} else {
    NSLog(@&quot;Error getting bitmap pixel data\n&quot;);
}    
CGContextRelease(context);
tempImage=[PublicHelper convertBitmapRGBA8ToUIImage:newBitmap withWidth:(int)width withHeight:(int)height];
free(newBitmap);
return tempImage;
</code></pre><p>newBitmap就是经过处理的图片的RGBA数组</p>
<p>关键错误应该是在这里：</p>
<pre><code>int R=bitmapData[i];
int G=bitmapData[i+1];
int B=bitmapData[i+2];
</code></pre><p>虽然说我们知道图片是由一堆RGBA构成的,但是我们并不知道RGBA的顺序呀～这并不像Android里面那么爽,Color是一个32bit(4字节)的数字(int),每个字节分别代表着ARGB</p>
<p>那么iOS呢?</p>
<p>查了很多的资料,看到各位大佬都说iOS上面是RGBA,那么我原来的写法,好像很RGBA啊,好像没什么问题啊～</p>
<h3 id="little-endian-big-endian"><a href="#little-endian-big-endian" class="headerlink" title="little-endian,big-endian"></a>little-endian,big-endian</h3><p>难道说,和大小端有关？？</p>
<p>虽然说是<code>RGBA</code>,但是存在数组里面的是<code>ABGR</code>?</p>
<p>抱着试一试和重构的态度,借鉴了各种大佬的代码,之后改成了这样</p>
<pre><code>const int imageWidth = originImage.size.width;
const int imageHeight = originImage.size.height;
size_t bytesPerRow = imageWidth * 4;
uint32_t* rgbImageBuf = (uint32_t*)malloc(bytesPerRow * imageHeight);    
CGColorSpaceRef colorSpace = CGColorSpaceCreateDeviceRGB();
CGContextRef context = CGBitmapContextCreate(rgbImageBuf, imageWidth, imageHeight, 8, bytesPerRow, colorSpace,kCGBitmapByteOrder32Little | kCGImageAlphaNoneSkipLast);
CGContextDrawImage(context, CGRectMake(0, 0, imageWidth, imageHeight), originImage.CGImage);
int pixelNum = imageWidth * imageHeight;
uint32_t* pCurPtr = rgbImageBuf;
for (int i = 0; i &lt; pixelNum; i++, pCurPtr++)
{
    uint8_t *ptr = (uint8_t*)pCurPtr;
    ptr[0] // Alpha
    ptr[1] // Blue
    ptr[2] // Greem
    ptr[3] // Red
    /**
     * 这里一点儿也不重要
     */
}
CGDataProviderRef dataProvider = CGDataProviderCreateWithData(NULL, rgbImageBuf, bytesPerRow * imageHeight,ProviderReleaseData);
CGImageRef imageRef = CGImageCreate(imageWidth, imageHeight, 8, 32, bytesPerRow, colorSpace,kCGImageAlphaLast | kCGBitmapByteOrder32Little, dataProvider,NULL, true, kCGRenderingIntentDefault);    
CGDataProviderRelease(dataProvider);
tempImage = [UIImage imageWithCGImage:imageRef];
CGImageRelease(imageRef);
CGContextRelease(context);
CGColorSpaceRelease(colorSpace);
return tempImage;

void ProviderReleaseData (void *info, const void *data, size_t size)
{
    free((void*)data);
}
</code></pre><p>现在用uint32_t来类比android中的Color</p>
<p>还用了DataProvider来把字节流转换成UIImage～这样修改后的代码,变得更加简洁了！</p>
<p>关键是,现在工作的正常了！</p>
<p><img src="http://vvk.ixuanlun.com/ios_xw_gif_right.png" alt="iOS GIF Right"></p>
<h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>不打不相识,Android和iOS不一起开发互相比较的话,就不能互相进步～</p>
<p>好了,这次不仅添加了GIF制作这个功能,还把以前的图片改色功能给修好了～真是一举两得啊！</p>
<h4 id="演示视频"><a href="#演示视频" class="headerlink" title="演示视频"></a>演示视频</h4><p><a href="https://www.bilibili.com/video/av13266294/" target="_blank" rel="noopener">iOS</a>&lt;=====&gt;<a href="https://www.bilibili.com/video/av13481745/" target="_blank" rel="noopener">Android</a></p>
<p>iOS这个视频里面的颜色修改,还没有改～.～</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170731-linkit-one-irremote.html">
                Linkit One 空调遥控器
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-07-31</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h3 id="使用linkit-one-控制空调"><a href="#使用linkit-one-控制空调" class="headerlink" title="使用linkit one 控制空调"></a>使用linkit one 控制空调</h3><p>这一篇会比较长,会写很多踩过的坑,一些知识,弯路,废话.</p>
<p>如果你想直接看结果,可以直接看小标题<code>Release</code></p>
<h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p>这夏天真是热,虽然成都比杭州的温度低7-10度,但是相比较舒适的22-25度来说,还是比较燥热的.</p>
<p>所以空调肯定是要开的.</p>
<p>可是,一直开会比较冷,开一会儿关掉又会比较热,即使空调有定时开定时关的功能,那这个操作在睡觉期间,只能做一次.它并不能智能的开关开关开关……</p>
<p>但是,自己做一个遥控器,就可以啊！</p>
<p>于是就开始着手搞这个了！</p>
<h4 id="My-Limitation"><a href="#My-Limitation" class="headerlink" title="My Limitation"></a>My Limitation</h4><p>我是个纯种的程序员,虽然说数电学的还不错,但是模电基本上都忘光了.所以要我画画板子,计算机算电阻电容,那我还不如直接放弃算了～</p>
<p>之前玩过Arduino,所以我对Arduino还算有点儿了解,所以肯定就选择这个平台了.</p>
<p>因为我们公司自己的智能硬件大部分都涉及到低功耗蓝牙,所以我觉得用蓝牙来进行互动对我来说开发起来也比较方便,所以我就选择了之前参加比赛骗来的Linkit One开发版.它自带了蓝牙、Wifi、GPS、GSM模块<code>(一波广告)</code></p>
<h4 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h4><p>DHT22温湿度传感器,IR发射器,IR接收器.</p>
<p>面包版,线,线,线,线,线…</p>
<p>Linkit One,Arduino开发环境, Linkit One SDK.</p>
<h4 id="Knowledge"><a href="#Knowledge" class="headerlink" title="Knowledge"></a>Knowledge</h4><p><code>以下内容基本上是摸索过程中学的,因为我一开始并没有觉得这个东西会那么的复杂</code></p>
<h5 id="遥控器和空调的通信"><a href="#遥控器和空调的通信" class="headerlink" title="遥控器和空调的通信"></a>遥控器和空调的通信</h5><p>一查就知道,他们用一个叫做38khz红外来通信.</p>
<p>那么38khz红外是个啥玩意儿呢？</p>
<p>先上图</p>
<p><img src="http://vvk.ixuanlun.com/linkit_one_irsignal.gif" alt="irsignal"></p>
<p>就是发射器在一定的时间内通过亮灭亮灭的快速切换来发送0,1,0,1</p>
<p>比如说 载波发射0.56ms,不发射0.56ms表示数字信号”0”;载波发射0.56ms,不发射1.68ms表示数字信号”1”</p>
<p>上面说的这个操作只是个<code>例子</code>,不代表所有的空调,电视什么的都用这种方式来表示0和1.</p>
<h5 id="Arduino"><a href="#Arduino" class="headerlink" title="Arduino"></a>Arduino</h5><p>这个怎么解释呢？</p>
<p>举个例子吧～</p>
<p>单片机工作起来就是在永远循环执行一个代码块儿.</p>
<p>在Arduino中有<code>void loop()</code>这个函数,在这个函数中把要循环做的事情放进去,就可以让它正常工作了.</p>
<p>比如说把某一个引脚置为高电平,只要简单的写一句<code>DigitalWrite(Pin Number,HIGH);</code>就OK了</p>
<p>读取某个引脚的点平值,只要简单的写一句<code>DigitalRead(Pin Number);</code>就OK了</p>
<p>差不多就这么个操作,基本上不用考虑什么中断、分片、多线程之类的东西</p>
<h5 id="发送指令＊"><a href="#发送指令＊" class="headerlink" title="发送指令＊"></a>发送指令＊</h5><p>虽然我们知道了如何让IR发射器发送红外信号,但是我们依然不知道这个空调的发射指令是什么～</p>
<p>这个学习指令几年前在机顶盒遥控器上面,就见过了.在拥有了IR接收器之后,他的原理其实蛮简单的.</p>
<p>IR接收器在收到高低点平切换的时候,记录一下时间,就可以知道发射端高低信号的持续时间了.</p>
<p>比如说:</p>
<p>我抓到的关机指令</p>
<pre><code>4360,4410,477,2205,237,266,520,1678,514,1734,484,693,367,527,533,1767,479,735,370,482,539,1956,309,491,630,550,477,2208,2234,473,532,1748,482,563,515,1585,1065,1449,281,1590,1090,1402,347,461,539,2139,208,1542,506,2262,185,283,769,343,536,516,551,522,942,1422,420,512,556,513,1150,1339,331,1584,544,1762,552,430,581,496,565,1133,198,316,846,266,539,489,574,526,807,339,531,1694,503,1729,517,1614,521,1753,456,1645,522,5371,4506,4419,463,1699,726,292,531,1601,838,1442,524,476,576,508,1098,1414,279,501,567,514,1063,1484,309,466,555,510,557,1766,693,1394,538,1135,205,1455,511,503,547,1773,450,1674,517,1719,480,1634,555,486,562,1736,535,1564,540,1758,737,288,499,520,553,540,822,339,522,1663,532,504,1096,200,381,1680,509,1762,436,1650,524,505,571,1044,205,389,753,322,560,527,565,1199,190,260,789,334,512,1625,903,1428,434,1599,1139,1335,316,1592,559
</code></pre><p>开机指令</p>
<pre><code>4385,4385,471,1690,447,579,527,1600,996,1236,548,498,584,490,8521,561,106,171,65,62,61,64,67,58,62,450,226,562,504,1590,571,528,722,1503,546,1593,839,312,555,481,571,1630,583,1695,528,1577,572,1693,516,1589,560,518,658,1564,553,1582,753,405,535,524,591,491,571,511,771,410,497,1621,563,1747,514,466,579,1601,567,726,457,459,537,509,627,491,557,531,653,473,527,1620,609,489,852,1388,518,1776,437,1712,485,1740,441,5368,4596,4410,400,1570,553,523,556,1700,567,1552,569,526,809,351,491,1634,554,528,560,621,506,1597,594,493,592,786,360,1571,572,1590,657,463,554,1599,566,1721,502,535,549,513,563,1701,506,1607,562,1771,463,1596,552,1806,458,474,580,1582,556,1709,500,510,567,522,558,536,820,320,534,525,564,1611,584,1677,526,488,561,1874,338,519,565,517,569,512,575,520,660,479,547,523,560,1618,735,377,564,1606,576,1685,520,1619,557,1721,505
</code></pre><p>有了这一坨数据,后面只要控制IR发射器Data引脚*,就可以发送红外指令了！</p>
<h5 id="PWM-脉冲宽度调制"><a href="#PWM-脉冲宽度调制" class="headerlink" title="PWM(脉冲宽度调制)"></a>PWM(脉冲宽度调制)</h5><p>嗯,这个东西我琢磨了会儿才明白.</p>
<p>一开始我一直不明白,我要这玩意儿干嘛.</p>
<p>引用百度百科里面的解释: <code>脉冲宽度调制是利用微处理器的数字输出来对模拟电路进行控制的一种非常有效的技术,广泛应用在从测量、通信到功率控制与变换的许多领域中.</code></p>
<p>不过后面在<code>pj大佬</code>的教导下,我明白了它的意思,简单说就是我要发高电平,就发PWM波；我要发低点平,就不发PWM波.这看起来和AM调制一样,不同的是AM调制是对一个模拟信号进行调制；而我这里用到的是对数字信号进行调制.</p>
<p>我就假设我说明白了～</p>
<h4 id="Dev"><a href="#Dev" class="headerlink" title="Dev"></a>Dev</h4><p>对于DHT和蓝牙的开发我就不多写了,因为真的蛮简单的,也没什么大坑.最多吐槽一下Linkit One这个板子对BLE蓝牙的限制吧～这家伙不能修改广播数据(改不了名字、服务UUIDs、制造商数据……),而且外设模式下Notify貌似是没有用的～</p>
<p>好嘞,蓝牙和温湿度都讲完了！下面可以一心一意的讲IR发射的坑了.</p>
<h5 id="Arduino-IRRemote"><a href="#Arduino-IRRemote" class="headerlink" title="Arduino-IRRemote"></a>Arduino-IRRemote</h5><p>在我真正开始这个项目的之前,我做了一些估计.查了我需要的各种模块的开发难度,找找有没有什么可以用的库可以直接调用.</p>
<p><a href="https://github.com/adafruit/DHT-sensor-library" target="_blank" rel="noopener">DHT温湿度传感器</a></p>
<p><a href="https://github.com/z3t0/Arduino-IRremote" target="_blank" rel="noopener">IR发射接收</a></p>
<p><a href="https://github.com/WiserUFBA/ArduMideaWrapper" target="_blank" rel="noopener">美的空调Arduino发射接收</a></p>
<p>我找到了这三个库,觉得这个项目在元件齐全了之后大概只要一个下午就可以搞定了.</p>
<p>于是,收到IR发射器之后,我就迫不及待的开工了！</p>
<pre><code>~~~/Arduino/libraries/IRremote/irISR.cpp:18:5: error: expected constructor, destructor, or type conversion before &apos;(&apos; token
ISR (TIMER_INTR_NAME)
</code></pre><p>编译错误！我溯源找到了这个类,发现了ISR()这个函数,并没有写他的来源,说明这个函数可能是板子自带的.于是我就用Arduino UNO来编译相同的代码,编译通过！</p>
<p>天啦噜,Arduino-IRRemote这个库是不支持Linkit One的！</p>
<p>吓得我赶紧去看看那个直接发美的空调指令的库,这个库,<code>也是调用Arduino-IRRemote的</code>！</p>
<h5 id="异想天开的做法"><a href="#异想天开的做法" class="headerlink" title="异想天开的做法"></a>异想天开的做法</h5><p>然后我就把发射代码搞出来,放到了Arduino UNO上面来运行.竟然可以成功的关闭空调了！</p>
<p>于是我陷入了深深的沉思～</p>
<p>难道说,我得用两颗单片机来做这个简单的小玩意儿？？</p>
<p>说实话,我真的这么折腾了一段时间,效果和想象中的并不一样,这可能和模拟电路的知识有关～</p>
<h5 id="手动生成PWM！"><a href="#手动生成PWM！" class="headerlink" title="手动生成PWM！"></a>手动生成PWM！</h5><p>回到原始的方法,我开始理解IRRemote发送数据的工作原理</p>
<p>发送原始数据</p>
<pre><code>void  IRsend::sendRaw (unsigned int buf[],  int len,  int hz)
{
    // Set IR carrier frequency
    enableIROut(hz);

    for (int i = 0;  i &lt; len;  i++) {
        if (i &amp; 1)  space(buf[i]) ;
        else        mark (buf[i]) ;
    }

    space(0);  // Always end with the LED off
}
</code></pre><p>这好像是发高电平</p>
<pre><code>void  IRsend::mark (int time)
{
    TIMER_ENABLE_PWM; // Enable pin 3 PWM output
    if (time &gt; 0) delayMicroseconds(time);
}
</code></pre><p>这好像是发低电平</p>
<pre><code>void  IRsend::space (int time)
{
    TIMER_DISABLE_PWM; // Disable pin 3 PWM output
    if (time &gt; 0) delayMicroseconds(time);
}
</code></pre><p>这就当作是配置PWM的频率吧</p>
<pre><code>void  IRsend::enableIROut (int khz)
{
    // Disable the Timer2 Interrupt (which is used for receiving IR)
    TIMER_DISABLE_INTR; //Timer2 Overflow Interrupt

    pinMode(TIMER_PWM_PIN, OUTPUT);
    digitalWrite(TIMER_PWM_PIN, LOW); // When not sending PWM, we want it low
    TIMER_CONFIG_KHZ(khz);
}
</code></pre><p>在<code>TIMER_DISABLE_PWM</code>、<code>TIMER_ENABLE_PWM</code>里面调用了很多和ISR,PWM有关的东西,所以这里开始就要重新了</p>
<p>先写个高电平</p>
<pre><code>void mark(int time){
    int t=0;
    boolean isHigh=false;
    while(t&lt;=time){
        isHigh=!isHigh;
        t+=enable_pwm(isHigh);
    }
}

int enable_pwm(boolean high){
    if(high){
        digitalWrite(3,HIGH);
    }else{
        digitalWrite(3,LOW);
    }
    delayMicroseconds(13);
    return 13;
}
</code></pre><p>通过计算38khz的一个周期是26微秒,所以我们13微秒就要转换一次电平～</p>
<p>再写个低电平</p>
<pre><code>void space(int time){
    digitalWrite(3,LOW);
    delayMicroseconds(time);
}
</code></pre><p>这个不需要发转电平,所以就轻松一些了～</p>
<p>由于我已经固定了13微秒转换一次,所以也不用实现enableIROut(int khz)这个函数了.</p>
<p>运行！编译通过！发送！IR接收机采集到了IR信号！可是～空调好像没反应～</p>
<h5 id="还有这种操作"><a href="#还有这种操作" class="headerlink" title="还有这种操作"></a>还有这种操作</h5><p>气氛一度很尴尬,不过我毕竟只是个普通人,看不到发送的数据长什么样子,所以在<code>添哥大佬</code>的帮助下我使用了高档示波器</p>
<p>这是空调遥控器发出的信号在接受端的样子</p>
<p><img src="http://vvk.ixuanlun.com/linkit_one_need_signal1.jpeg" alt="right signal"></p>
<p>这是我发出的信号在接受端的样子</p>
<p><img src="http://vvk.ixuanlun.com/linkit_one_need_signal2.jpeg" alt="error signal"></p>
<p>这<code>尖峰</code>哪儿来的？</p>
<p>检查代码真的没有问题,这个异常我只能归结为硬件问题了,要知道linkit one是一个很高级,很牛逼的硬件,它甚至有多线程的操作,所以,它会不会强行的我把我操作所在的线程给中断了呢？又或者linkit one并没有能力做那么高频的电平转换.</p>
<h5 id="analogWriteAdvance"><a href="#analogWriteAdvance" class="headerlink" title="analogWriteAdvance"></a>analogWriteAdvance</h5><p>气氛再一度尴尬,不过<code>添哥大佬</code>在官方文档的<code>Analog I/O</code>中找到了<code>analogWriteAdvance()</code>这个函数！</p>
<pre><code>void analogWriteAdvance(
uint32_t pin, 
uint32_t sourceClock, 
uint32_t clockDivider, 
uint32_t cycle, 
uint32_t dutyCycle
);
</code></pre><p>而他的例子里面就是生成了一个PWM波！</p>
<p>在经过<code>不</code>简单的计算之后,我改写了PWM波的生成和暂停</p>
<pre><code>//Enable 38khz PWM
analogWriteAdvance(PWM_PIN,PWM_SOURCE_CLOCK_13MHZ,PWM_CLOCK_DIV1,342,171);
//Disable 38khz PWM
analogWriteAdvance(PWM_PIN,PWM_SOURCE_CLOCK_13MHZ,PWM_CLOCK_DIV1,342,0);
</code></pre><p>编译上传运行,<code>滴</code>,空调开了～(由于这是在公司做的,所以信号序列也是公司空调的序列,所以回到寝室,还得再改一下)</p>
<h5 id="时好时坏的遥控器"><a href="#时好时坏的遥控器" class="headerlink" title="时好时坏的遥控器"></a>时好时坏的遥控器</h5><p>回到了寝室,我赶紧把新的数据放进去,对准空调,发了开机指令……再发一次……再发一次</p>
<p>还是没用？？不过关机指令倒是可以了</p>
<p>这说明发送是可以的,只是内容还有问题.</p>
<p>在网上搜寻了很久的开关机数据,都不太行,这是我想起了那个<code>美的空调遥控指令</code>的库！</p>
<p>之前,我不能使用它,是因为IRRemote中无法使用Linkit One的PWM波发生器,所以如果我改了那个发射函数,不就OK了嘛！</p>
<p>它需要什么方法我就给什么方法,连名字和参数都一样!</p>
<p>VKIRSender.h</p>
<pre><code>class VKIRSender{
public:
    void mark(int time);
    void space(int time);
    void enableIROut(int hz);
};
</code></pre><p>VKIRSender.cpp</p>
<pre><code>#include &quot;VKIRSender.h&quot;
#include &lt;Arduino.h&gt;

#define PWM_PIN 3

void VKIRSender::mark(int time){
    analogWriteAdvance(PWM_PIN,PWM_SOURCE_CLOCK_13MHZ,PWM_CLOCK_DIV1,342,171);
    delayMicroseconds(time);
}

void VKIRSender::space(int time){
    analogWriteAdvance(PWM_PIN,PWM_SOURCE_CLOCK_13MHZ,PWM_CLOCK_DIV1,342,0);
    delayMicroseconds(time);
}

void VKIRSender::enableIROut(int hz){

}
</code></pre><p>在这个库的帮助下,我甚至可以不使用抓来的数据,我甚至可以设定温度,冷热模式,风速……</p>
<p>试验了一下,<code>滴</code>！成功了</p>
<h4 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h4><p>开发历程差不多就是这样,真的好艰辛～</p>
<p>当然,现在还存在一个比较大的问题,就是发射距离！</p>
<p>我只能在离空调1M的位置,让空调听话,稍微远一点,他就不听话了～</p>
<p>在解决了这个问题之后,就可以配合温湿度传感器,让它智能起来了！</p>
<h4 id="RELEASE"><a href="#RELEASE" class="headerlink" title="RELEASE"></a>RELEASE</h4><p>前面废话那么多,这下面才是最有用的～</p>
<p>代码开源了,其实并没有什么很难得地方,只是由于踩了很多坑,所以我觉得公开给大家伙用用,可能还是蛮好的.</p>
<p>去<a href="https://github.com/VikingWarlock/Linkit-One-Bluetooth-AC-Remoter" target="_blank" rel="noopener">Github</a>看,给个Star当然也是极好的～</p>
<p>接线差不多是这个样子的</p>
<p><img src="http://vvk.ixuanlun.com/linkit_one_irremote_small.jpg" alt="board"></p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170630-android-bluetooth-crap.html">
                Android上见鬼的蓝牙
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-06-30</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <p>以前发的各种蓝牙开发的文章中使用的程序,都是在我自己的手机上完美运行过的.</p>
<p>我信心满满的就把app发布了.</p>
<p>之后就收到了很多邮件…各种投诉,说蓝牙完全搜索不到啦!蓝牙连不上啦!用不了啦!</p>
<p>和公司之前所有Android版本的蓝牙功能相比,我做的这个版本在扫描附近蓝牙的时候,可以实时的更新蓝牙信号的强度.<br>完美解决了之前用户拿着app不知道哪一个蓝牙是前轮,哪一个蓝牙是后轮.</p>
<p>这一套在我自己的手机(Nexus 6P)上完美流畅的运行了,在一些用户的手机上竟然出现了,完全扫描不到蓝牙外设的情况!</p>
<p>其实在发布之前,我们公司内部所有的android手机都参与了测试,虽然手机不同,性能不同,但是都没有出现完全搜索不到的现象.</p>
<p>于是我掏出我的坚果手机(不是坚果pro),打开了搜索界面,也出现了搜索的结果,只不过…过了一会儿,它们就消失了!</p>
<h4 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h4><p>于是我就接上电脑看看控制台都说了一些什么…</p>
<p>在搜索到了某一个设备的蓝牙广播之后,系统好像就不想再收这个蓝牙外设的广播信号了!</p>
<p>我的搜索界面是定时刷新可用的蓝牙外设列表的,在判断某一个蓝牙外设是不是还存在的时候,我用了时间戳.每次底层搜索到蓝牙外设的时候,我会在model层更新这个蓝牙外设的时间戳.每次View层获取最新列表数据的时候,把每个设备的更新时间戳减去当前的时间戳,如果超过一个阈值,说明这个蓝牙外设已经不存在了.</p>
<pre><code>public class ScanItem {

    private BluetoothDevice device;
    private int rssi;
    private int model;
    private long updateTime;
    private boolean connecting;
    private boolean connected;

    /**
    ...
    **/

    public boolean isAvailable(){
        return ((System.currentTimeMillis()-updateTime)&lt;2000);
    ｝
｝
</code></pre><p>在判断这里我的阈值是2秒,看来在某些垃圾手机上面,是不能酱紫的.于是我就改成了20秒.</p>
<p>运行起来,发现还是不行……</p>
<p>因为,不管过多少秒,这个垃圾系统都不在把收到的广播信息返回给我了！</p>
<h4 id="See-see-dalao’s-work"><a href="#See-see-dalao’s-work" class="headerlink" title="See see dalao’s work"></a>See see dalao’s work</h4><p>然后我想到,有那么多做蓝牙的app,我看看它们怎么运行的,怎么实时更新信号强度的.</p>
<p>我下载了我最喜欢的<a href="https://play.google.com/store/apps/details?id=com.macdom.ble.blescanner" target="_blank" rel="noopener">BLE Scanner</a>,运行了起来,发现很完美啊.</p>
<p>然后我就在控制台里面看,发现这个app在一个劲的停止搜索,开始搜索,停止搜索,开始搜索……</p>
<p>或许这是一个好方法！既然这种破系统一次扫描对一个设备只会给一次广播信号,那我只能多次停止扫描开启扫描咯.</p>
<pre><code>if (VKBluetoothManager.getInstance().isScanning()){
    VKBluetoothManager.getInstance().stopScan();
    handler.postDelayed(scanControlRunnable,50);
}else {
    VKBluetoothManager.getInstance().scanDevices();
    handler.postDelayed(scanControlRunnable,950);
}
</code></pre><p>心满意足的运行了起来,发现完美,这个破坚果终于达成了实时刷新的效果！</p>
<p>But……在Nexus 6P上面竟然出现了系统错误</p>
<pre><code>E/BtGatt.GattService: App &apos;XuanWheel&apos; is scanning too frequently
</code></pre><p>Are you f**king kidding me?</p>
<p>这样不行,那样也不行～</p>
<p>扫描的太频繁,意思应该是刚结束扫描后,再次开始的时间间隔太短了吧.</p>
<p>于是我就改了两个时间postdelay的延迟时间</p>
<pre><code>if (VKBluetoothManager.getInstance().isScanning()){
    VKBluetoothManager.getInstance().stopScan();
    handler.postDelayed(scanControlRunnable,2000);
}else {
    VKBluetoothManager.getInstance().scanDevices();
    handler.postDelayed(scanControlRunnable,4000);
}
</code></pre><p>这样子就可以了！</p>
<p>嗯,虽然说这样子实现了实时刷新信号强度的功能,但是毕竟刷新率还是很低的……而且本来Nexus 6p可以拥有更高的刷新率,为了兼容这些臭系统,只能一起降低效果了……这么看起来,还是iOS比较好～</p>
<h4 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h4><p>那么,为啥某些Android系统要这么搞呢！</p>
<p>我猜,他们为了提高电池寿命,节省CPU资源,让UI更加流畅,所以牺牲了一些使用频率不那么高的外设的性能,于是我们可怜的蓝牙,就这么被阉割了.不过你们在系统里面搞幺蛾子,用户不会说什么,但是用户的手机在使用需要蓝牙的app的时候,这些开发者就很悲催了呀～他们(我们)明明遵守着设计准则,却发现自己的程序跑在了假系统上,还被用户吐槽,被打一星,真是有苦说不清啊…</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170501-use-handler-or-thread-to-make-a-timer.html">
                用handler/thread来做定时器
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-05-01</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <p>刚开始接触android编程的时候,是大三.那时候在做精益防伪的演示版App,网络协议用的是socket.</p>
<p>使用socket的时候,编译器告诉我,需要在新线程中来使用socket操作.</p>
<p>于是乎,就学习了Thread的使用.</p>
<p>当时觉得Thread好像还是蛮简单的.在thread里面搞一个runnable,在runnable里面跑代码块,用start(),stop()来控制线程的开始和结束.</p>
<p>之后在thread中操控了ui,就闪退了.因为UI只能在主线程中去操作.这iOS就牛逼了,即使不在主线程中去操作,他也不会闪退.他会自动的在主线程中去渲染.</p>
<h3 id="分界线"><a href="#分界线" class="headerlink" title="分界线"></a>分界线</h3><p>言归正传,后面上课,老师让我们用thread来做一个定时器,在主线程中显示一个数字,在另一个线程中定时增加数字.</p>
<p>这玩意儿是来学习Thread和Handler的.</p>
<p>之后需要用到定时器的地方我都用Thread来实现了~</p>
<h3 id="然而"><a href="#然而" class="headerlink" title="然而"></a>然而</h3><p>Thread不是很安全.而且,对于不同的手机厂商,不同的ROM,对thread的操作也是不一样的.</p>
<pre><code>Thread workingThread = new Thread(new Runnable() {
        @Override
        public void run() {
            while (isWorking) {
                byte[] wantSend = sendingData();
                if (wantSend == null || mainCharacteristic == null || mainGatt == null) {
                    dataPointer = 0;
                    isWorking=false;
                    workingThread.interrupt();
                } else {
                    mainCharacteristic.setValue(wantSend);
                    mainGatt.writeCharacteristic(mainCharacteristic);
                    if (dataPointer == 0 &amp;&amp; dataStack.size() &gt; 0) {
                        try {
                            Thread.sleep(gifInterval);
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    } else {
                        try {
                            Thread.sleep(baseInterval);
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                }
            }
        }
    });
</code></pre><p>某些手机上,这个thread是停不下来的.在某些手机上,这个thread是无法重启的.在某些手机上,这个thread是无法中断的.</p>
<p>这就意味着,某些手机上,炫轮app只能发送一次图片;在某些手机上,炫轮app无法显示附近的蓝牙.</p>
<p>查了一些资料,我才发现thread,的很多接口都被废弃了,而且非常不安全,很容易出现锁死卡死的情况.</p>
<p>于是我去检查了很早很早很早的炫轮app.发现是用延迟来做定时器功能的.</p>
<p>于是我把Runnable提取出来了:</p>
<pre><code>Runnable sendingRunnable=new Runnable() {
    @Override
    public void run() {
        if (isWorking) {
            byte[] wantSend = sendingData();
            if (wantSend == null || mainCharacteristic == null || mainGatt == null) {
                dataPointer = 0;
                isWorking=false;
            } else {
                mainCharacteristic.setValue(wantSend);
                mainGatt.writeCharacteristic(mainCharacteristic);
                if (dataPointer == 0 &amp;&amp; dataStack.size() &gt; 0) {
                        mHandler.postDelayed(sendingRunnable,gifInterval);
                } else {
                        mHandler.postDelayed(sendingRunnable,baseInterval);
                }
            }
        }
    }
};
</code></pre><p>用Handler的postDelayed来做延迟执行,这竟然就解决了前面所有的问题!</p>
<p>原因,我还要好好查些资料,再来补充.下次更新!</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/study/20170323-stack-doesnt-overflow.html">
                缓冲区为啥不溢出
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-03-23</span>
            
            
            
                <span class="category">
                    <a href="/categories/study/">学习</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <p>软件安全性分析课,里面花了很多时间讲缓冲区溢出的故事.</p>
<p>大一为了加入凝聚工作室,我也是查过相关的资料,也做过类似的实验,但都是瞎搞.</p>
<p>在老师给出例子之前,我一直把失败归结于自己的代码有问题,或者攻击方式有问题.</p>
<p>在看了老师的例子之后,我觉得我好像没写错什么…</p>
<h4 id="Run-directly"><a href="#Run-directly" class="headerlink" title="Run directly"></a>Run directly</h4><p>现在内核牛逼了呢!</p>
<p>检查到了pc指向非法地址,就直接被内核终止了,所以,我也没办法</p>
<h4 id="Debug-with-GDB"><a href="#Debug-with-GDB" class="headerlink" title="Debug with GDB"></a>Debug with GDB</h4><p>GDB真是个牛逼的东西,可以反编译,可以打断点,可以查看堆栈地址数据……</p>
<p>只要我在执行非法内存之前加个断点,看看栈数据是不是变得乱七八糟了,我的实验目的就达到了.</p>
<p>根据老师说的</p>
<pre><code>char c[20];
char a;
</code></pre><p>这玩意儿运行的时候,在栈上面的顺序是ca</p>
<p>所以只要用不安全的函数,冲破c的长度,就可以覆盖a的数据.</p>
<p>然而gdb断点的时候,我惊奇的发现顺序是ac…</p>
<p>于是乎我就换了个代码</p>
<pre><code>char a;
char c[20];
char b;
</code></pre><p>发现,栈里面是abc…</p>
<p>这,这你让我怎么溢出??</p>
<p>还要再研究研究…不论我是否使用优化编译,结果都是这样的…</p>
<p>等我找到答案,再来更新这一篇!</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/study/20170310-I-know-nothing.html">
                啥都不懂…
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-03-10</span>
            
            
            
                <span class="category">
                    <a href="/categories/study/">学习</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <p>这学期好像做了个死,选了一堆学不会的课~</p>
<p>什么机器学习啊(全是数学,全是概率,已弃疗)</p>
<p>什么Linux内核啊(除了学会了装内核,使用gdb,和装逼,别的都没听懂)</p>
<p>什么软件安全性分析啊(我自己实验永远做不出老师的效果)</p>
<p>安全通信啊(这个我还听得懂……)</p>
<p>报名了华为软件挑战赛(也弃疗了)</p>
<p>为了要听懂Linux内核的课和一部分软件安全性分析的课,我借了买了一些计算机组成原理,编译原理,Binary Hack的书.</p>
<p>好像也没咋看懂~</p>
<p>然后要做推荐算法,就看数据挖掘,好像还是没咋看懂~</p>
<p>所以我承认我笨了…</p>

        </div>
    

</div>
            
                
<div class="post">

    <div class="post-header index">
        <h1 class="title">
            <a href="/programming/20170213-uiwindow-problem.html">
                UIWindow 之坑
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-02-13</span>
            
            
            
                <span class="category">
                    <a href="/categories/programming/">编程</a>
                </span>
            
        </div>
    </div>

    
        <div class="content">
            <h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p>做一个Pop View有两种方法.</p>
<pre><code>1.用一个UIView盖在当前UIView或者UIWindow的最上面

2.做一个UIWindow,让他变成keyWindow
</code></pre><p>第一种的好处是…没想到什么特别的好处,大概写起来简单吧.</p>
<p>第二种的好处是,可以扔个ViewController在里面,哈哈哈.</p>
<p>而且第二种,我觉得做起来结构比较清晰.这个Pop View里面做的事情,可以全部封装好,包括显示和消失.<br>而使用UIView的话,做显示就一定需要把superview作为参数传入,才可以显示,这个还是蛮麻烦的,特别是当我<br>想做一个全局接收通知,并在UI上显示的东西的时候.由于很难确定当前最顶上的UIView是什么,所以还是UIWindow比较好.</p>
<h4 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h4><p>然而,在水壶架iOS端中,遇到了一个很奇怪的问题.这个问题貌似只在iOS9.3.5之前的系统上出现.对于之后的系统,没有出现这个问题.</p>
<p>从Leancloud的错误报告中看到,这是一个消息传到了空指针的fetal错误.</p>
<p>那就好好找找,为啥变成了空指针吧.</p>
<h4 id="Come-on-Where-are-you"><a href="#Come-on-Where-are-you" class="headerlink" title="Come on, Where are you"></a>Come on, Where are you</h4><p>由于一开始这个问题只在9.3.5的手机上出现了,而我和一大票iOS10都没有这个问题.所以我甚至怀疑,这个是手机的问题.</p>
<p>直到我发现所有的老系统,都爆了!我才慌了.</p>
<p>当弹出这个搜索框,再让他消失的时候,做任何的触摸操作,整个app就挂掉了.</p>
<p>所以,问题肯定就在dismiss方法里面!</p>
<pre><code>-(void)disappear
{
    [UIView animateWithDuration:0.3f animations:^{
        self.view.alpha=0;
    } completion:^(BOOL finished) {
        _displayWindows.rootViewController=nil;
            _displayWindows.hidden=YES;
            _displayWindows=nil;
        [[BluetoothManager sharedManager]stopScan];
        [BluetoothManager sharedManager].delegate=nil;
        if (self.delegate) {
            self.delegate=nil;
        }
    }];
}
</code></pre><p>每次disappear之后,我就中断了整个app,查看他的UI结构,发现有一个不听话的UIWindow还停留在哪儿~</p>
<p>而我明明都把他设置为hidden了,按理说它已经不是keyWindow了~可是他貌似还在.</p>
<p>而且为什么这个东西在iOS 10就没问题了呢~</p>
<p>于是我就去查了查iOS 10的开发这手册,看看他们都做了些什么改变,导致iOS 10不会闪退.</p>
<p>扯远了.</p>
<p>所以说,当这个alert级的UIWindow设置为hidden的时候,没有key window了……</p>
<p>于是乎Touch Event进来的时候,不知道应该给谁了,就爆掉了……</p>
<p>所以所以,得把之前的UIWindow重新恢复key window的地位.</p>
<p>之后改成这样了:</p>
<pre><code>-(void)disappear
{
    [UIView animateWithDuration:0.3f animations:^{
        self.view.alpha=0;
    } completion:^(BOOL finished) {
        _displayWindows.windowLevel=UIWindowLevelNormal;
        _displayWindows.rootViewController=nil;
        [self.view removeFromSuperview];
            [_displayWindows setHidden:YES];
            _displayWindows=nil;
        [[BluetoothManager sharedManager]stopScan];
        [BluetoothManager sharedManager].delegate=nil;
        if (self.delegate) {
            self.delegate=nil;
        }
    }];
    if (_preWindows) {
        [_preWindows makeKeyAndVisible];
        _preWindows=nil;
    }
}
</code></pre><p>当然这样一改,在show的时候也要做一些修改了~得把之前的UIWindow给记录下来,不然就懵逼咯.</p>

        </div>
    

</div>
            
        </section>
    </div>
</div>



    <div class="row">
        <div class="col-sm-12">
            <div class="wrap-pagination">
                <a class="" href="/page/4/">
                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </a>
                <a class="" href="/page/6/">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>




</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a target="_blank" rel="noopener" href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/life/20230123-2023-reconciliation.html">2023 reconciliation</a>
            </li>
            
            <li>
                <a class="footer-post" href="/life/20220206-2022-noname.html">2021 roll king</a>
            </li>
            
            <li>
                <a class="footer-post" href="/life/20210211-2021-what-a-tough-year.html">重启2020</a>
            </li>
            
            <li>
                <a class="footer-post" href="/life/20200121-2020-enbrace-change.html">2020唯一不变的是变化</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/hack/">黑科技</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/book/">书记</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/wtf/">什么鬼</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/study/">学习</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://telegram.org/">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a target="_blank" rel="noopener" href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a target="_blank" rel="noopener" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->

<script src="/js/main.js"></script>


<!-- Disqus Comments -->



</body>

</html>